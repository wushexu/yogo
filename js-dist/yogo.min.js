function Board(a,b,c){this.boardContainer=a;"string"===typeof a&&(this.boardContainer=document.getElementById(a));c?(c.clear(),this.paper=c):this.paper=Raphael(a);"number"===typeof b?(this.boardSize=b,this.boardSetting=Board.getDefaultBoardSetting(this.boardSize)):"object"===typeof b&&(this.boardSetting=b,this.boardSize=this.boardSetting.boardSize);this.pointStatusMap={};this.zoomMode=null;this.coordinateManager=new Board.Coordinate(this);yogo.exportFunctions.call(this,this.coordinateManager,["drawCoordinate",
"hideCoordinate","showCoordinate","boardCoorToViewBoxCoor"]);this.stoneManager=new Board.Stone(this);yogo.exportFunctions.call(this,this.stoneManager,"placeStone removeStone addStones removeStones showMoveNumber showMoveNumbers hideMoveNumbers unmarkCurrentMoveNumber".split(" "));this.markerManager=new Board.Marker(this);yogo.exportFunctions.call(this,this.markerManager,["setMarker","setMarkers","removeMarker","removeAllMarkers","markCurrentMove"]);this.labelManager=new Board.Label(this);yogo.exportFunctions.call(this,
this.labelManager,["setLabel","setLabels","removeLabel","removeAllLabels","removeBranchPointLabels"])}
Board.getDefaultBoardSetting=function(a){(isNaN(a)||5>a||51<a)&&yogo.logError("wrong board size: "+a,"board");var b=20,c=3,d=3,e=12,f=12,g=2*e+2*c+f+d,k=b*(a-1)+g;if(19!=a)var g=18*b+g,l=k/g,k=g,b=b/l,c=c/l,d=d/l,e=e/l,f=f/l;var g=c+f+e+d,g={x:g,y:g},c=c+f/2,d={x:{basey:c,type:"A"},y:{basex:c,type:"1"},fontSize:b/2,coordinatePadding:d,coordinateWidth:f},f={outerBorderLine:.03*b,borderLine:.025*b,star:.045*b,stone:.02*b,stoneSpacing:.01*b},c={fontSize:b/2+3},l={fontSize:b/2+1},h=[];1==a%2&&(h.push({x:(a-
1)/2,y:(a-1)/2}),13<=a&&(h.push({x:3,y:(a-1)/2}),h.push({x:a-4,y:(a-1)/2}),h.push({x:(a-1)/2,y:3}),h.push({x:(a-1)/2,y:a-4})));if(11<=a)h.push({x:3,y:3}),h.push({x:3,y:a-4}),h.push({x:a-4,y:3}),h.push({x:a-4,y:a-4});else if(8==a||9==a)h.push({x:2,y:2}),h.push({x:2,y:a-3}),h.push({x:a-3,y:2}),h.push({x:a-3,y:a-3});return{viewBoxSize:k,boardSize:a,starPoints:h,boardOrigin:g,gridWidth:b,boardOuterEdge:e,strokes:f,labels:c,coordinate:d,moveNumbers:l}};
Board.prototype={drawBoard:function(){var a=this.boardSetting,b=this.paper,c=a.viewBoxSize;yogo.logInfo("viewBox size:"+c,"board");b.setViewBox(0,0,c,c);var d=a.boardSize,c=a.boardOrigin,e=a.gridWidth,f=a.boardOuterEdge,g=a.strokes,k=e*(d-1)+2*f,f=b.rect(c.x-f,c.y-f,k,k);f.attr({"stroke-width":0});f.attr({fill:"#DCB35C"});b.rect(c.x,c.y,e*(d-1),e*(d-1)).attr({"stroke-width":g.outerBorderLine});for(var l=k="",f=0;f<d-2;f++)k+="M"+c.x+" "+(c.y+e+e*f)+"H"+(c.x+e*(d-1)),l+="M"+(c.x+e+e*f)+" "+c.y+"V"+
(c.y+e*(d-1));b.path(k).attr({"stroke-width":g.borderLine});b.path(l).attr({"stroke-width":g.borderLine});a=a.starPoints;for(f=0;f<a.length;f++)d=a[f],b.circle(c.x+e*d.x,c.y+e*d.y,g.star).attr({fill:"black"});this.drawCoordinate()},clearBoard:function(){for(statusKey in this.pointStatusMap){var a=this.pointStatusMap[statusKey];a.color&&this.removeStone(a.coor)}this.removeAllMarkers();this.removeAllLabels();this.markCurrentMove(null)},zoomBoard:function(a){this.zoomMode=a;var b=this.boardSetting.viewBoxSize,
c=this.boardSetting.coordinate,d=c.coordinatePadding+c.coordinateWidth,b=b-d,e=this.boardSetting.gridWidth,c=b/2+e/2,f=d,d=d+b/2-e/2;this.coordinateManager.coordinateShowed&&(f=0,b=this.boardSetting.viewBoxSize);"TL"===a?this.paper.setViewBox(f,f,c,c):"TR"===a?this.paper.setViewBox(d,f,c,c):"BL"===a?this.paper.setViewBox(f,d,c,c):"BR"===a?this.paper.setViewBox(d,d,c,c):this.paper.setViewBox(f,f,b,b)},resize:function(){var a=this.boardContainer.offsetWidth;this.paper.setSize(a,a)}};
Board.Coordinate=function(a){this.board=a;this.boardSize=a.boardSize;this.boardSetting=a.boardSetting;this.paper=a.paper;this.setting=this.boardSetting.coordinate;this.coordinateLabels=[];this.coordinateShowed=!1};
Board.Coordinate.prototype={generateCoordinateLabel:function(a,b){var c=""+(a+1);if("a"===b||"A"===b)26<=a?c=String.fromCharCode(65+(a-26)):"a"===b?c=String.fromCharCode(97+a):"A"===b&&(c=String.fromCharCode(65+a));return c},drawCoordinate:function(){for(var a=this.boardSetting.gridWidth,b=this.boardSetting.boardOrigin,c=0;c<this.boardSize;c++){var d=b.x+a*c,e=this.generateCoordinateLabel(c,this.setting.x.type),d=this.paper.text(d,this.setting.x.basey,e).attr({"font-size":this.setting.fontSize});
this.coordinateLabels.push(d);d=b.y+a*c;e=this.generateCoordinateLabel(c,this.setting.y.type);d=this.paper.text(this.setting.y.basex,d,e).attr({"font-size":this.setting.fontSize});this.coordinateLabels.push(d)}this.coordinateShowed=!0},hideCoordinate:function(){if(this.coordinateShowed){for(var a=0;a<this.coordinateLabels.length;a++)this.coordinateLabels[a].hide();this.coordinateShowed=!1;var a=this.setting.coordinatePadding+this.setting.coordinateWidth,b=this.boardSetting.viewBoxSize;this.paper.setViewBox(a,
a,b-a,b-a)}},showCoordinate:function(){if(!this.coordinateShowed){var a=this.boardSetting.viewBoxSize;this.paper.setViewBox(0,0,a,a);for(a=0;a<this.coordinateLabels.length;a++)this.coordinateLabels[a].show();this.coordinateShowed=!0}},coordinateStatus:function(){return this.coordinateShowed},boardCoorToViewBoxCoor:function(a){var b=this.boardSetting.boardOrigin,c=this.boardSetting.gridWidth;return{x:b.x+c*a.x,y:b.y+c*a.y}}};
Board.Label=function(a){this.board=a;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMap=a.pointStatusMap;this.coordinateManager=a.coordinateManager;this.labelPoints=[];this.branchPoints=[]};
Board.Label.prototype={setLabel:function(a,b,c){if(b)if(2<b.length)yogo.logError("label too long: "+b,"setLabel");else{var d="x"+a.x+"y"+a.y,e=this.pointStatusMap[d],f=null,g=null;e?(f=e.color,g=e.label):(e={},this.pointStatusMap[d]=e);g&&e.labelElement.remove();d="black";"B"==f&&(d="white");"branch_point"===c&&(d="blue",f&&yogo.logWarn("branch point ("+a.x+","+a.y+") has a stone","setLabel"));f=this.boardSetting.labels.fontSize;2==b.length&&(f-=1);g=this.coordinateManager.boardCoorToViewBoxCoor(a);
f=this.paper.text(g.x,g.y,b).attr({"font-size":f,fill:d});e.labelElement=f;e.label=b;"branch_point"===c?this.branchPoints.push(a):this.labelPoints.push(a)}else yogo.logError("label missing: ("+a.x+","+a.y+")","setLabel")},setLabels:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.setLabel(c,c.label)}},removeLabel:function(a){(a=this.pointStatusMap["x"+a.x+"y"+a.y])&&a.label&&(a.labelElement.remove(),a.labelElement=null,a.label=null)},removeAllLabels:function(){for(;0<this.labelPoints.length;)this.removeLabel(this.labelPoints.pop())},
removeBranchPointLabels:function(){for(;0<this.branchPoints.length;)this.removeLabel(this.branchPoints.pop())}};Board.Marker=function(a){this.board=a;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMap=a.pointStatusMap;this.coordinateManager=a.coordinateManager;this.templateMarkerPoint={x:-this.boardSetting.gridWidth,y:-this.boardSetting.gridWidth};this.currentMoveMarker=null;this.markerPoints=[];this.markerTemplates=this.setupMarkerTemplates()};
Board.Marker.prototype={setupMarkerTemplates:function(){var a=this.paper,b=this.boardSetting.gridWidth,c=this.boardSetting.strokes,d=this.templateMarkerPoint,e=a.circle(d.x,d.y,.23*b).attr({"stroke-width":.1*b}),f=e.clone().attr({stroke:"white"}),g=.4*b,g=a.rect(d.x,d.y,g,g).attr({"stroke-width":0,fill:"white"}),k=g.clone().attr({fill:"black"}),l=.5*b,h=l*Math.sin(Math.PI/3),m=l/2*Math.tan(Math.PI/6),l=a.path("M"+(d.x-l/2)+" "+(d.y+m)+"h"+l+"l"+-l/2+" "+-h+"Z"),h=l.clone().attr({"stroke-width":0,
fill:"black"});l.attr({"stroke-width":c.borderLine,fill:"white"});c=.32*b;m=.1*b;c=a.path("M"+(d.x-c/2)+" "+(d.y-c/2)+"l"+c+" "+c+"M"+(d.x-c/2)+" "+(d.y+c/2)+"l"+c+" "+-c);c.attr({"stroke-width":m,"stroke-linecap":"round"});m=c.clone().attr({color:"white"});a=a.circle(d.x,d.y,.13*b).attr({"stroke-width":.04*b,fill:"white"});b=a.clone().attr({fill:"black"});return{CR_B:f,SQ_B:g,TR_B:l,MA_B:m,CR_W:e,SQ_W:k,TR_W:h,MA_W:c,CR_E:e,SQ_E:k,TR_E:h,MA_E:c,TW:a,TB:b}},markCurrentMove:function(a){var b=this.boardSetting.gridWidth;
this.currentMoveMarker&&(this.currentMoveMarker.remove(),this.currentMoveMarker=null);a&&(a=this.coordinateManager.boardCoorToViewBoxCoor(a),this.currentMoveMarker=this.paper.circle(a.x,a.y,.15*b).attr({"stroke-width":0,fill:"red"}))},setMarker:function(a,b){var c="x"+a.x+"y"+a.y,d=this.pointStatusMap[c],e=null,f=null;d?(e=d.color,f=d.marker):(d={},this.pointStatusMap[c]=d);f&&(yogo.logWarn("point ("+a.x+","+a.y+") has a marker","setMarker"),d.markerElement.remove());c=null;c=b+"_"+(e||"E");if("TW"==
b||"TB"==b){if("W"==e&&"TW"==b||"B"==e&&"TB"==b)return;c=b}if(e=this.markerTemplates[c]){c=e.clone();e=this.coordinateManager.boardCoorToViewBoxCoor(a);if("CR"==b||"TW"==b||"TB"==b)c.attr({cx:e.x,cy:e.y});else if("SQ"==b){var g=c.getBBox();c.attr({x:e.x-g.width/2,y:e.y-g.height/2})}else c.getBBox(),c.transform("t"+(e.x-this.templateMarkerPoint.x)+","+(e.y-this.templateMarkerPoint.y));c.show();d.marker=b;d.markerElement=c;f||this.markerPoints.push(a)}else yogo.logError("markerTemplate "+c+" not found",
"setMarker")},setMarkers:function(a,b){for(var c=0;c<a.length;c++)this.setMarker(a[c],b)},removeMarker:function(a){var b=this.pointStatusMap["x"+a.x+"y"+a.y];b&&b.marker?(b.marker=null,b.markerElement.remove(),b.markerElement=null):yogo.logWarn("no marker at ("+a.x+","+a.y+")","removeMarker")},removeAllMarkers:function(){for(;0<this.markerPoints.length;)this.removeMarker(this.markerPoints.pop())}};
Board.Stone=function(a){this.board=a;this.boardSize=a.boardSize;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMap=a.pointStatusMap;this.coordinateManager=a.coordinateManager;this.stoneTemplates=this.setupStoneTemplates();this.moveNumberElements=[];this.currentMoveNumberElement=null};
Board.Stone.prototype={setupStoneTemplates:function(){var a=this.boardSetting.strokes,a=this.paper.circle(-this.boardSetting.gridWidth,-this.boardSetting.gridWidth,this.boardSetting.gridWidth/2-a.stoneSpacing).attr({"stroke-width":a.stone,fill:"black"});return{blackStone:a,whiteStone:a.clone().attr({fill:"white"})}},placeStone:function(a,b){if("B"!=b&&"W"!=b)yogo.logWarn("wrong color:"+b,"place stone");else{var c="x"+a.x+"y"+a.y,d=this.pointStatusMap[c];if(d&&d.color){yogo.logWarn("point occupied: ("+
a.x+","+a.y+",color:"+d.color+")","place stone");if(b==d.color)return;var e=d["stone"+("B"==b?"W":"B")];e&&e.hide()}d||(d={coor:a});d.color=b;if(e=d["stone"+b])e.show();else{var e=("B"==b?this.stoneTemplates.blackStone:this.stoneTemplates.whiteStone).clone(),f=this.coordinateManager.boardCoorToViewBoxCoor(a);e.attr({cx:f.x,cy:f.y});d["stone"+b]=e;this.pointStatusMap[c]=d}}},removeStone:function(a){var b=this.pointStatusMap["x"+a.x+"y"+a.y];if(b){var c=b["stone"+b.color];c?(c.hide(),b.moveNumberElement&&
(b.moveNumberElement.hide(),b.moveNumberElement=null)):yogo.logWarn("stone not exist: ("+a.x+","+a.y+")","remove stone");b.color=null}else yogo.logWarn("point empty: ("+a.x+","+a.y+")","remove stone")},addStones:function(a,b){for(var c=0;c<a.length;c++)this.placeStone(a[c],b)},removeStones:function(a){for(var b=0;b<a.length;b++)this.removeStone(a[b])},showMoveNumber:function(a){var b=this.pointStatusMap["x"+a.x+"y"+a.y];b&&b.color||yogo.logWarn("point empty: ("+a.x+","+a.y+")","show move number");
b.color!=a.color&&yogo.logWarn("wrong color: ("+a.x+","+a.y+")","show move number");var c=a.moveNumber,d=b["stone"+b.color],e=d.data("mn_"+c);if(e)a.current&&(this.unmarkCurrentMoveNumber(),e.attr({fill:"red"}),this.currentMoveNumberElement=e),e.show(),this.moveNumberElements.push(e);else{e="black";"B"==b.color&&(e="white");var f=e;a.current&&(e="red");var g=this.boardSetting.moveNumbers.fontSize;9<c?g-=1:99<c&&(g-=2);var k=this.coordinateManager.boardCoorToViewBoxCoor(a),e=this.paper.text(k.x,k.y,
c).attr({"font-size":g,fill:e});e.data("oriColor",f);d.data("mn_"+c,e);b.moveNumberElement=e;this.moveNumberElements.push(e);a.current&&(this.unmarkCurrentMoveNumber(),this.currentMoveNumberElement=e)}},unmarkCurrentMoveNumber:function(){if(this.currentMoveNumberElement){var a=this.currentMoveNumberElement.data("oriColor");this.currentMoveNumberElement.attr({fill:a});this.currentMoveNumberElement=null}},showMoveNumbers:function(a){for(var b=0;b<a.length;b++)this.showMoveNumber(a[b])},hideMoveNumbers:function(){for(;0<
this.moveNumberElements.length;)this.moveNumberElements.pop().hide()}};
function Game(a,b){this.board=a;this.gameModel=b;this.boardSize=b.boardSize;this.curNode=b.nodes[0];this.onPlayNode=null;this.nodeNavigator=new Game.NodeNavigator(this);yogo.exportFunctions.call(this,this.nodeNavigator,"gotoNextX gotoLastX gotoNode gotoBeginning gotoGameEnd fastFoward fastBackward goinBranch gotoVariationBegin gotoVariationEnd backFromVariation".split(" "));this.markersManager=new Game.Markers(this);yogo.exportFunctions.call(this,this.markersManager,"setCurrentNodeMarkers setMarkers setMarkCurrentMove setMarkBranchPoints markBranchPointsIfAny setShowMoveNumber hideMoveNumbers handleMoveNumbers".split(" "))}
Game.prototype={diffPosition:function(a,b){for(var c=[],d=[],e=[],f=0;f<this.boardSize;f++){var g=a[f],k=b[f];if(g!==k)for(var l=0;l<this.boardSize;l++){var h=g[l],m=k[l];if(h!==m&&(h||m)){var n=!1,p=!1;m?h?h.color!=m.color&&(p=n=!0):p=!0:n=!0;h={x:f,y:l};n&&c.push(h);p&&("B"==m.color?e.push(h):d.push(h))}}}return{stonesToRemove:c,stonesToAddB:e,stonesToAddW:d}},playNode:function(a){if(!a)return!1;var b=this.board,c=this.curNode,d=this.curNode=a;a=!0;if(d.status.positionBuilt){if(d==c)return!1;if(c.nextNode!=
d||d.status.capture||d.status.setup)c.previousNode!=d||c.status.capture||c.status.setup?(d=this.diffPosition(c.position,d.position),b.removeStones(d.stonesToRemove),b.addStones(d.stonesToAddB,"B"),b.addStones(d.stonesToAddW,"W")):(e=c.move.point)&&b.removeStone(e);else{var e=d.move.point;e&&b.placeStone(e,d.move.color)}}else a=(new Game.PositionBuilder(this,d)).buildPosition();this.setCurrentNodeMarkers();this.handleMoveNumbers(c);"function"===typeof this.onPlayNode&&this.onPlayNode.call(this);return a},
buildAllPositions:function(){var a=this,b=[];this.gameModel.traverseNodes(null,function(b,d){!1===(new Game.PositionBuilder(a,b,!0)).buildPosition()&&d.push(b)},b);return b},inRealGame:function(){return this.curNode.belongingVariation.realGame}};Game.Markers=function(a){this.game=a;this.board=a.board;this.markBranchPoints=this.markCurrentMove=!0;this.showMoveNumber=!1;this.showMoveNumberCount=10;this.hideMoveNumberTemporarily=!1};
Game.Markers.prototype={setCurrentNodeMarkers:function(){var a=this.board;a.removeAllMarkers();a.removeAllLabels();a.removeBranchPointLabels();var b=this.game.curNode;if(b.status.mark){b.marks.LB&&a.setLabels(b.marks.LB);for(var c="TR CR SQ MA TW TB".split(" "),d=0;d<c.length;d++){var e=c[d];b.marks[e]&&this.setMarkers(b.marks[e],e,!0)}}this.markBranchPoints&&this.markBranchPointsIfAny();this.markCurrentMove&&!this.showMoveNumber?a.markCurrentMove(b.move.point):a.markCurrentMove(null)},setMarkers:function(a,
b,c){var d=this.board;if(c)for(c=0;c<a.length;c++){var e=a[c];e.coorFrom?(e=yogo.evaluatePointRange(e.coorFrom,e.coorTo),d.setMarkers(e,b)):d.setMarker(e,b)}else d.setMarkers(a,b)},setMarkCurrentMove:function(a){(this.markCurrentMove=a)?this.board.markCurrentMove(this.game.curNode.move.point):this.board.markCurrentMove(null)},setMarkBranchPoints:function(a){(this.markBranchPoints=a)?this.markBranchPointsIfAny():this.board.removeBranchPointLabels()},markBranchPointsIfAny:function(){var a=this.game.curNode.branchPoints;
if(a)for(var b=0;b<a.length;b++)if(!(25<b)){var c=a[b],d=String.fromCharCode(65+b);this.board.setLabel(c,d,"branch_point")}},setShowMoveNumber:function(a){"boolean"===typeof a?(this.showMoveNumber=a,0==this.showMoveNumberCount&&(this.showMoveNumberCount=1)):"number"===typeof a?(this.showMoveNumberCount=a,this.showMoveNumber=0<a):"string"===typeof a&&(a=parseInt(a),NaN(a)||(this.showMoveNumberCount=a,this.showMoveNumber=0<a));this.showMoveNumber?this.board.markCurrentMove(null):this.board.markCurrentMove(this.game.curNode.move.point);
this.resetMoveNumbers()},resetMoveNumbers:function(){this.board.hideMoveNumbers();if(this.showMoveNumber){for(var a=[],b=this.showMoveNumberCount,c=this.game.curNode,d=c.belongingVariation,e=c.position;0<b;b--){var f=c.move.point;if(f){var g=e[f.x][f.y];g&&g.node===c&&(f={x:f.x,y:f.y,color:c.move.color,moveNumber:c.numbers.displayMoveNumber},c===this.game.curNode&&(f.current=!0),a.push(f))}if(!d.realGame&&(c.status.variationFirstNode||c.belongingVariation!==d))break;c=c.previousNode;if(!c)break}this.board.showMoveNumbers(a)}},
hideMoveNumbers:function(){this.board.hideMoveNumbers()},handleMoveNumbers:function(a){var b=this.board,c=this.game.curNode;if(c.status.mark)this.hideMoveNumberTemporarily=!0,this.hideMoveNumbers(),this.markCurrentMove&&b.markCurrentMove(c.move.point);else if(this.hideMoveNumberTemporarily)this.hideMoveNumberTemporarily=!1,this.resetMoveNumbers();else{var d=!1;if(0!==this.showMoveNumberCount&&!this.showMoveNumberCount){if(c.label&&a.nextNode==c){var e=c.belongingVariation;if(e.realGame||e==a.belongingVariation)(d=
c.move.point)?(e=c.numbers.displayMoveNumber,d={x:d.x,y:d.y,color:c.move.color,moveNumber:e,current:!0},b.showMoveNumber(d)):b.unmarkCurrentMoveNumber(),d=!0}if(a.previousNode==c&&(e=a.belongingVariation,e.realGame||e==c.belongingVariation)){if(d=c.move.point)e=c.numbers.displayMoveNumber,d={x:d.x,y:d.y,color:c.move.color,moveNumber:e,current:!0},b.showMoveNumber(d);d=!0}}d||this.resetMoveNumbers()}}};
function GameModel(){this.realGame=!0;this.nodes=[];this.gameInfo={};this.variationMap={};this.nodeMap={};this.nodesByMoveNumber=[];this.gameEndingNode=null}
GameModel.prototype={traverseNodes:function(a,b,c){for(var d=this.nodes,e=0;e<d.length;e++){var f=d[e];if(b&&!1===b.call(f,f,c))break;if(f=f.variations)for(var g=0;g<f.length;g++){var k=f[g];if(a&&!1===a.call(k,k,c))return c;k.traverseNodes(a,b,c)}}return c},selectNodes:function(a){return this.traverseNodes(null,function(b,c){a.call(b,b)&&c.push(b)},[])}};function Variation(a,b){this.baseNode=a;this.parentVariation=b;this.realGame=!1;this.nodes=[];this.index=0;this.id=null}
Variation.prototype={nextVariation:function(){var a=this.baseNode.variations,b=(this.index+1)%a.length;0==b&&(b=1);return a[b]},previousVariation:function(){var a=this.baseNode.variations,b=(this.index-1+a.length)%a.length;0==b&&(b=a.length-1);return a[b]}};Variation.prototype.traverseNodes=GameModel.prototype.traverseNodes;Variation.prototype.selectNodes=GameModel.prototype.selectNodes;function Node(a,b){this.previousNode=a;this.belongingVariation=b;this.props={};this.status={};this.id=null}
Node.prototype={};
Game.NodeNavigator=function(a){this.game=a;this.gameModel=a.gameModel;a=[{name:"Node",predicate:function(){return!0}},{name:"Branch",predicate:function(a){return!!a.variations}},{name:"Comment",predicate:function(a){return a.status.comment}},{name:"CommentOrBranch",predicate:function(a){return a.status.comment||!!a.variations}},{name:"Remark",predicate:function(a){return a.status.remark}},{name:"Marks",predicate:function(a){return a.status.mark}},{name:"Ko",predicate:function(a){a=a.status;return a.positionBuilt&&
(a.startKo||a.ko)}},{name:"Capture",predicate:function(a){return a.status.positionBuilt&&a.status.capture}},{name:"NotEvaluated",predicate:function(a){return!a.status.positionBuilt}}];for(var b=function(a,b){return function(){return a.call(this,b)}.bind(this)}.bind(this),c=0;c<a.length;c++){var d=a[c],e=d.predicate,f="next"+d.name,d="previous"+d.name;this.game[f]=this[f]=b(this.gotoNextX,e);this.game[d]=this[d]=b(this.gotoLastX,e)}};
Game.NodeNavigator.prototype={gotoNextX:function(a){for(var b=this.game.curNode;;){if(b.nextNode)b=b.nextNode;else if(b.variations)b=b.variations[0].nodes[0];else return!1;if(!b)return!1;if(a.call(b,b))return this.game.playNode(b)}},gotoLastX:function(a){for(var b=this.game.curNode;;){b=b.previousNode;if(!b)return!1;if(a.call(b,b))return this.game.playNode(b)}},gotoNode:function(a){var b;"string"===typeof a?b=this.gameModel.nodeMap[a]:"number"===typeof a?b=this.gameModel.nodesByMoveNumber[a]:a instanceof
Node&&(b=a);return b?this.game.playNode(b):!1},gotoBeginning:function(){return this.game.playNode(this.gameModel.nodes[0])},gotoGameEnd:function(){return this.game.playNode(this.gameModel.gameEndingNode)},fastFoward:function(a){a=a||10;for(var b=this.game.curNode;0<a;a--)if(b.nextNode)b=b.nextNode;else if(b.variations)b=b.variations[0].nodes[0];else break;return this.game.playNode(b)},fastBackward:function(a){a=a||10;for(var b=this.game.curNode;0<a;a--)if(b.previousNode)b=b.previousNode;else break;
return this.game.playNode(b)},goinBranch:function(a){var b=this.game.curNode.variations;if(b){var c;"number"===typeof a?c=b[a]:"string"===typeof a&&1==a.length&&(a=a.charCodeAt(0)-65,c=b[a]);if(c)return this.game.playNode(c.nodes[0])}return!1},gotoVariationBegin:function(){return this.game.inRealGame()||this.game.curNode.status.variationFirstNode?!1:this.gotoLastX(function(a){return a.status.variationFirstNode})},gotoVariationEnd:function(){return this.game.inRealGame()||this.game.curNode.status.variationLastNode?
!1:this.gotoNextX(function(a){return a.status.variationLastNode})},backFromVariation:function(){return this.game.inRealGame()?!1:this.game.playNode(this.game.curNode.belongingVariation.baseNode)}};Game.PositionBuilder=function(a,b,c){this.game=a;this.board=a.board;this.gameModel=a.gameModel;this.boardSize=a.gameModel.boardSize;this.curNode=b;this.buildPositionOnly=c||!1;this.basePosition=null;this.position=[]};
Game.PositionBuilder.prototype={getPointColor:function(a,b){var c=(this.position[a]||this.basePosition[a])[b];return c?c.color:null},setPointColor:function(a,b,c){var d=null;c&&(d={color:c,node:this.curNode});if(!this.position[a])for(this.position[a]=[],c=0;c<this.basePosition[a].length;c++)this.position[a][c]=this.basePosition[a][c];this.position[a][b]=d},getFinalPosition:function(){for(var a=0;a<this.boardSize;a++)this.position[a]||(this.position[a]=this.basePosition[a]);return this.position},setPointsStatus:function(a,
b){for(var c=0;c<a.length;c++){var d=a[c];this.setPointColor(d.x,d.y,b)}},getAdjacentPointsStatus:function(a){a=[{x:a.x-1,y:a.y},{x:a.x,y:a.y-1},{x:a.x+1,y:a.y},{x:a.x,y:a.y+1}];for(var b=this.boardSize,c=0;4>c;c++){var d=a[c],e=d.x,f=d.y;0<=e&&0<=f&&e<b&&f<b?d.color=this.getPointColor(e,f):a[c]=null}return a},traverseGroup:function(a,b,c){function d(a,k){var l="x"+a.x+"y"+a.y;if(!e[l]){var h=f.getAdjacentPointsStatus(a),m=c(a,h);if(!1===m)return!1;e[l]=!0;for(l=0;4>l;l++)if(m=h[l],null!=m&&m.color==
b&&k!==l&&(m=d(m,(k+2)%4),!1===m))return!1}}var e={},f=this;return d(a)},checkGroupLiberties:function(a,b){var c=[];return!1===this.traverseGroup(a,b,function(a,b){c.push(a);for(var f=0;4>f;f++){var g=b[f];if(null!=g&&null==g.color)return!1}})?{hasLiberty:!0}:{hasLiberty:!1,groupPoints:c}},removeStones:function(a,b){if(b)for(var c=0;c<a.length;c++){var d=a[c];d.coorFrom?(d=yogo.evaluatePointRange(d.coorFrom,d.coorTo),this.removeStones(d,!1)):(this.setPointColor(x,y,null),this.buildPositionOnly||this.board.removeStone(d))}else this.setPointsStatus(a,
null),this.buildPositionOnly||this.board.removeStones(a)},addStones:function(a,b,c){if(c)for(c=0;c<a.length;c++){var d=a[c];d.coorFrom?(d=yogo.evaluatePointRange(d.coorFrom,d.coorTo),this.addStones(d,b,!1)):(this.setPointColor(d.x,d.y,b),this.buildPositionOnly||this.board.placeStone(d,b))}else this.setPointsStatus(a,b),this.buildPositionOnly||this.board.addStones(a,b)},checkOpponentLiberties:function(a,b){for(var c=[],d=this.getAdjacentPointsStatus(a),e=0;4>e;e++){var f=d[e];f&&f.color==b&&(f=this.checkGroupLiberties(f,
f.color),f.hasLiberty||(f=f.groupPoints,this.removeStones(f,!1),c=c.concat(f)))}return c},evaluateMove:function(){var a=this.curNode,b=a.move.color,c=a.move.point;if(this.getPointColor(c.x,c.y))return yogo.logWarn("point occupied: ("+c.x+","+c.y+","+b+")","play move"),!1;this.buildPositionOnly||this.board.placeStone(c,b);this.setPointColor(c.x,c.y,b);var d="B"==b?"W":"B",e=this.checkOpponentLiberties(c,d);if(0<e.length){if(1==e.length){var f=e[0],g=a.previousNode;if(g&&g.status.capture&&1==g.move.capturedStones.length){var k=
g.move.capturedStones[0],l=g.move[d];if(l&&f.x==l.x&&f.y==l.y&&c.x==k.x&&c.y==k.y)return yogo.logWarn("ko, cann't recapture immediately: ("+c.x+","+c.y+","+b+")","play move"),g.status.ko||(g.status.startKo=!0),!1}g&&g.previousNode&&g.previousNode.previousNode&&(g=g.previousNode.previousNode,g.status.capture&&1==g.move.capturedStones.length&&(k=g.move.capturedStones[0],(d=g.move[d])&&f.x==d.x&&f.y==d.y&&c.x==k.x&&c.y==k.y&&(a.status.ko=!0,g.status.ko||(g.status.startKo=!0),yogo.logInfo("ko: ("+c.x+
","+c.y+","+b+")","play move"))))}a.status.capture=!0;a.move.capturedStones=e;c=a.move.accumulatedCaptures;c={B:c.B,W:c.W};c[b]+=e.length;a.move.accumulatedCaptures=c}else if(!this.checkGroupLiberties(c,b).hasLiberty)return yogo.logWarn("is self capture? ("+c.x+","+c.y+","+b+")","play move"),this.setPointColor(c.x,c.y,null),this.buildPositionOnly||this.board.removeStone(c),!1;return!0},buildPosition:function(){var a=!0,b=this.curNode;if(b.status.positionEvaluated)return a;var c=b.previousNode;if(c)c.status.positionBuilt||
(new Game.PositionBuilder(this.game,c)).buildPosition(),this.basePosition=c.position,b.move.accumulatedCaptures=c.move.accumulatedCaptures;else{this.basePosition=[];for(c=0;c<this.boardSize;c++)this.basePosition[c]=[];b.move.accumulatedCaptures={B:0,W:0}}b.status.move&&(a=this.evaluateMove());if(b.status.setup&&(b.setup.AB&&this.addStones(b.setup.AB,"B",!0),b.setup.AW&&this.addStones(b.setup.AW,"W",!0),b.setup.AE))for(var c=function(a){var b=this.getPointColor(a.x,a.y);b&&(d.push({x:a.x,y:a.y,color:b}),
this.setPointColor(a.x,a.y,null),this.buildPositionOnly||this.board.removeStone(a))},d=b.setup.aeRemovedStones=[],e=b.setup.AE,f=0;f<e.length;f++){var g=e[f];if(g.coorFrom)for(var g=yogo.evaluatePointRange(g.coorFrom,g.coorTo),k=0;k<g.length;k++)c(g[k]);else c(g)}b.position=this.getFinalPosition();b.status.positionBuilt=!0;return a}};function GameViewer(a){this.game=a}
GameViewer.prototype={keydownHandler:function(a){var b=this.game,c=a.ctrlKey||a.metaKey;switch(a.keyCode){case 37:c?b.previousCommentOrBranch():b.previousNode();break;case 39:c?b.nextCommentOrBranch():b.nextNode();break;case 38:a=b.curNode;b.inRealGame()?a.variations&&(a=a.variations[a.variations.length-1],a=a.nodes[0],b.gotoNode(a)):a.status.variationFirstNode?(a=a.belongingVariation,a=a.previousVariation().nodes[0],b.gotoNode(a)):b.gotoVariationBegin();break;case 40:a=b.curNode,b.inRealGame()?a.variations&&
(a=a.variations[1],a=a.nodes[0],b.gotoNode(a)):a.status.variationLastNode?(a=a.belongingVariation,a=a.nextVariation().nodes[0],b.gotoNode(a)):b.gotoVariationEnd()}return!0},mousewheelHandler:function(a){var b=this.game;!a.wheelDelta&&a.originalEvent&&(a=a.originalEvent);0<=a.wheelDelta?b.previousNode():b.nextNode();return!1}};String.prototype.trim||(String.prototype.trim=function(){rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;return this.replace(rtrim,"")});
Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var c;if(null==this)throw new TypeError("");var d=Object(this),e=d.length>>>0;if(0===e)return-1;c=+b||0;Infinity===Math.abs(c)&&(c=0);if(c>=e)return-1;for(c=Math.max(0<=c?c:e-Math.abs(c),0);c<e;){if(c in d&&d[c]===a)return c;c++}return-1});
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;e.prototype=new d;return e});
function SgfParser(){function a(a){var c={};for(groupName in a)for(var d=a[groupName].split(" "),e=0;e<d.length;e++)c[d[e]]=groupName;return c}this.gameInfoPropNameToGroup=a({root:"GM FF AP SZ CA ST",basic:"GN EV RO DT PC RE GC",rule:"HA KM RU TM OT",blackPlayer:"PB BR BS BT",whitePlayer:"PW WR WS WT",recorder:"US SO AP",misc:"CP ON AN"});this.nodePropNameToGroup=a({basic:"N C",setup:"AB AW AE",move:"B W BL WL PL MN OB OW KO FG V",remark:"GB GW UC DM TE BM DO IT HO",marks:"LB TR CR SQ MA SL TW TB AR LN",
inheritProps:"PM DD DW"});this.propNameToType=a({integer:"MN OB OW PM SZ HA ST","float":"V KM",bool:"DO IT KO",triple:"GB GW UC DM TE BM HO",point:"B W",lableList:"LB",pointList:"AB AW AE TR CR SQ MA SL AR LN TW TB DD VM",stringArray:""})}
SgfParser.prototype={parseSgf:function(a){function b(){g&&(f.props[g]=k,k=g=null)}var c=[],d=null,e,f,g,k,l=0;a=a.match(/[()\[\];\\]|[^()\[\];\\]*/g);for(var h="",m=0;m<a.length;m++){var n=a[m];"\\"==n?"inPropValue"==d?(n=a[++m],n.startsWith("\n")&&(n=n.substr(1)),h+=n):yogo.logError("unexpected token: \\","parse sgf"):"inPropValue"==d&&"]"!=n?h+=n:"("==n?(0==l?(e=new GameModel,c.push(e)):(b(),d=e,e=new Variation(f,d),d.realGame&&!f.variations?(e.realGame=!0,f.variations=[]):(e.realGame=!1,f.variations||
(f.variations=[])),e.index=f.variations.length,f.variations.push(e)),h="",d=null,e.variationDepth=l,l++):")"==n?(b(),h="",l--,0>l?yogo.logError("dismatch parenthesis: )","parse sgf"):(f=e.baseNode,0==e.nodes.length&&(yogo.logWarn("empty variation!","parse sgf"),f.variations.pop()),e=e.parentVariation,d=null)):";"==n?(b(),h="",d=f,f=new Node(d,e),d&&d.belongingVariation===e&&(d.nextNode=f),d&&d.belongingVariation===e||(f.status.variationFirstNode=!0),e.nodes.push(f),d="inProp"):"["==n?d="inPropValue":
"]"==n?("C"!=g&&(h=h.trim()),k?k instanceof Array?k.push(h):k=[k,h]:k=h,h="",d="inProp"):"inProp"==d?(h+=n,h=h.trim(),""!=h&&(/[a-zA-Z0-9]+/.test(h)?(b(),g=h,h=""):yogo.logError("unexpected property name: "+h,"parse sgf"))):h+=n}return c},buildGoGameModel:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.processGameInfo(c);var d=this;c.traverseNodes(null,function(a,b){a.basic||(a.basic={});a.move||(a.move={});var g=a.props;for(name in g){var k=d.nodePropNameToGroup[name];if(k){var l=g[name],
l=d.propertyTypeConvert(l,d.propNameToType[name],c.boardSize);a[k]||(a[k]={});a[k][name]=l}else d.gameInfoPropNameToGroup[name]?a.previousNode&&yogo.logWarn("game info not at the first node: "+name,"node"):yogo.logWarn("unknown property name: "+name,"node")}a.status.move=!(!a.move.W&&!a.move.B);a.status.pass=null===a.move.W||null===a.move;a.status.setup=!!a.setup;a.status.comment=!(!a.basic||!a.basic.C);a.status.remark=!!a.remark;a.status.mark=!!a.marks;a.nextNode||a.variations||(a.status.variationLastNode=
!0);a.move.W&&a.move.B&&yogo.logWarn("both Black and White move in one node: B["+a.props.B+"],W["+a.props.W+"]","node");a.status.move&&(a.move.color=a.move.B?"B":"W",a.move.point=a.move.W||a.move.B);delete a.props},{});c.traverseNodes(function(a,b){a.id="v"+b.seq++;c.variationMap[a.id]=a},function(a,b){var d=a.previousNode;d?(d=d.numbers,d=a.status.move||a.status.pass?[d.globalMoveNumber+1,d.displayMoveNumber+1,d.variationMoveNumber+1]:[d.globalMoveNumber,d.displayMoveNumber,d.variationMoveNumber]):
d=a.status.move||a.status.pass?[1,1,1]:[0,0,0];a.numbers={globalMoveNumber:d[0],displayMoveNumber:d[1],variationMoveNumber:d[2]};a.move.MN&&(a.numbers.displayMoveNumber=a.move.MN);a.status.variationFirstNode&&(a.numbers.variationMoveNumber=a.status.move||a.status.pass?1:0);if(a.variations){for(var d=a.variations,k=[],l=0;l<d.length;l++){var h=d[l].nodes[0];h.status.move&&k.push(h.move.B||h.move.W)}a.branchPoints=k}a.id="n"+b.seq++;c.nodeMap[a.id]=a;a.belongingVariation.realGame&&((d=a.numbers.globalMoveNumber)&&
!c.nodesByMoveNumber[d]&&(c.nodesByMoveNumber[d]=a),a.nextNode||a.variations||(c.gameEndingNode=a))},{seq:1E3})}},processGameInfo:function(a){function b(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=d[0];a[d[1]]=a[e];delete a[e]}}a.gameInfo||(a.gameInfo={});var c=a.gameInfo,d=a.nodes[0].props;d.GM&&"1"!==d.GM&&yogo.logError("unsupported game type: GM\x3d"+d.GM,"game info");d.SZ||yogo.logError("missing board size(SZ)","game info");for(name in d){var e=this.gameInfoPropNameToGroup[name];if(e){c[e]||
(c[e]={});var f=d[name];this.propNameToType[name]&&(f=this.propertyTypeConvert(f,this.propNameToType[name],a.boardSize));c[e][name]=f}else this.nodePropNameToGroup&&this.nodePropNameToGroup[name]||yogo.logWarn("unknown property name: "+name,"game info")}c.blackPlayer&&b(c.blackPlayer,[["PB","name"],["BR","rank"],["BS","species"],["BT","term"]]);c.whitePlayer&&b(c.whitePlayer,[["PW","name"],["WR","rank"],["WS","species"],["WT","term"]]);c=c.root.SZ;(isNaN(c)||5>c||51<c)&&yogo.logError("wrong board size(SZ)",
"game info");a.boardSize=c},parseCoordinate:function(a,b){if(!a.match(/^[a-z][a-z]$/i))return yogo.logWarn("wrong coordinate: "+a,"node"),null;var c=a.charCodeAt(0),d=a.charCodeAt(1),c=97>c?26+c-65:c-97,d=97>d?26+d-65:d-97;return c>=b||d>=b?null:{x:c,y:d}},propertyTypeConvert:function(a,b,c){var d=a;if(b)if(0<=["lableList","pointList","stringArray"].indexOf(b)?a instanceof Array||(a=[a]):a instanceof Array&&(a=a[0]||""),"point"==b)a=""==a?null:this.parseCoordinate(a,c);else if("lableList"==b){b=[];
for(d=0;d<a.length;d++){var e=a[d].split(":"),f=e[0];if(e=e[1])f=this.parseCoordinate(f,c),null!=f&&(f.label=e,b.push(f))}a=0<b.length?b:null}else if("pointList"==b){b=[];for(d=0;d<a.length;d++)f=a[d],0<f.indexOf(":")?(e=f.split(":"),f=this.parseCoordinate(e[0],c),e=this.parseCoordinate(e[1],c),f&&e&&b.push({coorFrom:f,coorTo:e})):(f=this.parseCoordinate(f,c),null!=f&&b.push(f));a=0<b.length?b:null}else"triple"==b?a="2"==a?2:1:"bool"==b?a=!0:"integer"==b?(a=parseInt(a),isNaN(a)&&yogo.logWarn("can't parse to Integer: "+
name+","+d,"node")):"float"==b?(a=parseFloat(a),isNaN(a)&&yogo.logWarn("can't parse to Float: "+name+","+d,"node")):yogo.logWarn("to do: "+name,"node");return a}};SgfParser.parse=function(a){var b=new SgfParser;a=b.parseSgf(a);b.buildGoGameModel(a);return a};
yogo={log:function(a,b,c){if(window.console&&((c=window.console[c])||(c=window.console.log),c instanceof Function)){b||(b="yogo");try{c.call(window.console,b+":",a)}catch(d){}}},logInfo:function(a,b){yogo.log(a,b,"info")},logWarn:function(a,b){yogo.log(a,b,"warn")},logError:function(a,b){yogo.log(a,b,"error")},exportFunctions:function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=a[d];"function"!==typeof e?yogo.logWarn(d+" is not a function"):this[d]=e.bind(a)}},evaluatePointRange:function(a,b){for(var c=
[],d=b.x,e=a.y,f=b.y,g=a.x;g<=d;g++)for(var k=e;k<=f;k++)c.push({x:g,y:k});return c}};
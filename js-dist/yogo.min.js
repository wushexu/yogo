function Board(a,c,b){this.boardContainer=a;"string"===typeof a&&(this.boardContainer=document.getElementById(a));b?(b.clear(),this.paper=b):this.paper=Raphael(a);"number"===typeof c?(this.boardSize=c,this.boardSetting=Board.getDefaultBoardSetting(this.boardSize)):"object"===typeof c&&(this.boardSetting=c,this.boardSize=this.boardSetting.boardSize);this.pointStatusMap={};this.zoomMode=null;this.coordinateManager=new Board.Coordinate(this);yogo.exportFunctions.call(this,this.coordinateManager,["drawCoordinate",
"hideCoordinate","showCoordinate","boardCoorToViewBoxCoor"]);this.stoneManager=new Board.Stone(this);yogo.exportFunctions.call(this,this.stoneManager,"placeStone removeStone addStones removeStones showMoveNumber showMoveNumbers hideMoveNumbers unmarkCurrentMoveNumber".split(" "));this.markerManager=new Board.Marker(this);yogo.exportFunctions.call(this,this.markerManager,["setMarker","setMarkers","removeMarker","removeAllMarkers","markCurrentMove"]);this.labelManager=new Board.Label(this);yogo.exportFunctions.call(this,
this.labelManager,["setLabel","setLabels","removeLabel","removeAllLabels","removeBranchPointLabels"])}
Board.getDefaultBoardSetting=function(a){(isNaN(a)||5>a||51<a)&&yogo.logError("wrong board size: "+a,"board");var c=20,b=3,d=3,e=12,f=12,g=2*e+2*b+f+d,k=c*(a-1)+g;if(19!=a)var g=18*c+g,l=k/g,k=g,c=c/l,b=b/l,d=d/l,e=e/l,f=f/l;var g=b+f+e+d,g={x:g,y:g},b=b+f/2,d={x:{basey:b,type:"A"},y:{basex:b,type:"1"},fontSize:c/2,coordinatePadding:d,coordinateWidth:f},f={outerBorderLine:.03*c,borderLine:.025*c,star:.045*c,stone:.02*c,stoneSpacing:.01*c},b={fontSize:c/2+3},l={fontSize:c/2+1},h=[];1==a%2&&(h.push({x:(a-
1)/2,y:(a-1)/2}),13<=a&&(h.push({x:3,y:(a-1)/2}),h.push({x:a-4,y:(a-1)/2}),h.push({x:(a-1)/2,y:3}),h.push({x:(a-1)/2,y:a-4})));if(11<=a)h.push({x:3,y:3}),h.push({x:3,y:a-4}),h.push({x:a-4,y:3}),h.push({x:a-4,y:a-4});else if(8==a||9==a)h.push({x:2,y:2}),h.push({x:2,y:a-3}),h.push({x:a-3,y:2}),h.push({x:a-3,y:a-3});return{viewBoxSize:k,boardSize:a,starPoints:h,boardOrigin:g,gridWidth:c,boardOuterEdge:e,strokes:f,labels:b,coordinate:d,moveNumbers:l}};
Board.prototype={drawBoard:function(){var a=this.boardSetting,c=this.paper,b=a.viewBoxSize;yogo.logInfo("viewBox size:"+b,"board");c.setViewBox(0,0,b,b);var d=a.boardSize,b=a.boardOrigin,e=a.gridWidth,f=a.boardOuterEdge,g=a.strokes,k=e*(d-1)+2*f,f=c.rect(b.x-f,b.y-f,k,k);f.attr({"stroke-width":0});f.attr({fill:"#DCB35C"});c.rect(b.x,b.y,e*(d-1),e*(d-1)).attr({"stroke-width":g.outerBorderLine});for(var l=k="",f=0;f<d-2;f++)k+="M"+b.x+" "+(b.y+e+e*f)+"H"+(b.x+e*(d-1)),l+="M"+(b.x+e+e*f)+" "+b.y+"V"+
(b.y+e*(d-1));c.path(k).attr({"stroke-width":g.borderLine});c.path(l).attr({"stroke-width":g.borderLine});a=a.starPoints;for(f=0;f<a.length;f++)d=a[f],c.circle(b.x+e*d.x,b.y+e*d.y,g.star).attr({fill:"black"});this.drawCoordinate()},clearBoard:function(){for(statusKey in this.pointStatusMap){var a=this.pointStatusMap[statusKey];a.color&&this.removeStone(a.coor)}this.removeAllMarkers();this.removeAllLabels();this.markCurrentMove(null)},zoomBoard:function(a){this.zoomMode=a;var c=this.boardSetting.viewBoxSize,
b=this.boardSetting.coordinate,d=b.coordinatePadding+b.coordinateWidth,c=c-d,e=this.boardSetting.gridWidth,b=c/2+e/2,f=d,d=d+c/2-e/2;this.coordinateManager.coordinateShowed&&(f=0,c=this.boardSetting.viewBoxSize);"TL"===a?this.paper.setViewBox(f,f,b,b):"TR"===a?this.paper.setViewBox(d,f,b,b):"BL"===a?this.paper.setViewBox(f,d,b,b):"BR"===a?this.paper.setViewBox(d,d,b,b):this.paper.setViewBox(f,f,c,c)},resize:function(){var a=this.boardContainer.offsetWidth;this.paper.setSize(a,a)}};
Board.Coordinate=function(a){this.board=a;this.boardSize=a.boardSize;this.boardSetting=a.boardSetting;this.paper=a.paper;this.setting=this.boardSetting.coordinate;this.coordinateLabels=[];this.coordinateShowed=!1};
Board.Coordinate.prototype={generateCoordinateLabel:function(a,c){var b=""+(a+1);if("a"===c||"A"===c)26<=a?b=String.fromCharCode(65+(a-26)):"a"===c?b=String.fromCharCode(97+a):"A"===c&&(b=String.fromCharCode(65+a));return b},drawCoordinate:function(){for(var a=this.boardSetting.gridWidth,c=this.boardSetting.boardOrigin,b=0;b<this.boardSize;b++){var d=c.x+a*b,e=this.generateCoordinateLabel(b,this.setting.x.type),d=this.paper.text(d,this.setting.x.basey,e).attr({"font-size":this.setting.fontSize});
this.coordinateLabels.push(d);d=c.y+a*b;e=this.generateCoordinateLabel(b,this.setting.y.type);d=this.paper.text(this.setting.y.basex,d,e).attr({"font-size":this.setting.fontSize});this.coordinateLabels.push(d)}this.coordinateShowed=!0},hideCoordinate:function(){if(this.coordinateShowed){for(var a=0;a<this.coordinateLabels.length;a++)this.coordinateLabels[a].hide();this.coordinateShowed=!1;var a=this.setting.coordinatePadding+this.setting.coordinateWidth,c=this.boardSetting.viewBoxSize;this.paper.setViewBox(a,
a,c-a,c-a)}},showCoordinate:function(){if(!this.coordinateShowed){var a=this.boardSetting.viewBoxSize;this.paper.setViewBox(0,0,a,a);for(a=0;a<this.coordinateLabels.length;a++)this.coordinateLabels[a].show();this.coordinateShowed=!0}},coordinateStatus:function(){return this.coordinateShowed},boardCoorToViewBoxCoor:function(a){var c=this.boardSetting.boardOrigin,b=this.boardSetting.gridWidth;return{x:c.x+b*a.x,y:c.y+b*a.y}}};
Board.Label=function(a){this.board=a;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMap=a.pointStatusMap;this.coordinateManager=a.coordinateManager;this.labelPoints=[];this.branchPoints=[]};
Board.Label.prototype={setLabel:function(a,c,b){if(c)if(2<c.length)yogo.logError("label too long: "+c,"setLabel");else{var d="x"+a.x+"y"+a.y,e=this.pointStatusMap[d],f=null,g=null;e?(f=e.color,g=e.label):(e={},this.pointStatusMap[d]=e);g&&e.labelElement.remove();d="black";"B"==f&&(d="white");"branch_point"===b&&(d="blue",f&&yogo.logWarn("branch point ("+a.x+","+a.y+") has a stone","setLabel"));f=this.boardSetting.labels.fontSize;2==c.length&&(f-=1);g=this.coordinateManager.boardCoorToViewBoxCoor(a);
f=this.paper.text(g.x,g.y,c).attr({"font-size":f,fill:d});e.labelElement=f;e.label=c;"branch_point"===b?this.branchPoints.push(a):this.labelPoints.push(a)}else yogo.logError("label missing: ("+a.x+","+a.y+")","setLabel")},setLabels:function(a){for(var c=0;c<a.length;c++){var b=a[c];this.setLabel(b,b.label)}},removeLabel:function(a){(a=this.pointStatusMap["x"+a.x+"y"+a.y])&&a.label&&(a.labelElement.remove(),a.labelElement=null,a.label=null)},removeAllLabels:function(){for(;0<this.labelPoints.length;)this.removeLabel(this.labelPoints.pop())},
removeBranchPointLabels:function(){for(;0<this.branchPoints.length;)this.removeLabel(this.branchPoints.pop())}};Board.Marker=function(a){this.board=a;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMap=a.pointStatusMap;this.coordinateManager=a.coordinateManager;this.templateMarkerPoint={x:-this.boardSetting.gridWidth,y:-this.boardSetting.gridWidth};this.currentMoveMarker=null;this.markerPoints=[];this.markerTemplates=this.setupMarkerTemplates()};
Board.Marker.prototype={setupMarkerTemplates:function(){var a=this.paper,c=this.boardSetting.gridWidth,b=this.boardSetting.strokes,d=this.templateMarkerPoint,e=a.circle(d.x,d.y,.23*c).attr({"stroke-width":.1*c}),f=e.clone().attr({stroke:"white"}),g=.4*c,g=a.rect(d.x,d.y,g,g).attr({"stroke-width":0,fill:"white"}),k=g.clone().attr({fill:"black"}),l=.5*c,h=l*Math.sin(Math.PI/3),m=l/2*Math.tan(Math.PI/6),l=a.path("M"+(d.x-l/2)+" "+(d.y+m)+"h"+l+"l"+-l/2+" "+-h+"Z"),h=l.clone().attr({"stroke-width":0,
fill:"black"});l.attr({"stroke-width":b.borderLine,fill:"white"});b=.32*c;m=.1*c;b=a.path("M"+(d.x-b/2)+" "+(d.y-b/2)+"l"+b+" "+b+"M"+(d.x-b/2)+" "+(d.y+b/2)+"l"+b+" "+-b);b.attr({"stroke-width":m,"stroke-linecap":"round"});m=b.clone().attr({color:"white"});a=a.circle(d.x,d.y,.13*c).attr({"stroke-width":.04*c,fill:"white"});c=a.clone().attr({fill:"black"});return{CR_B:f,SQ_B:g,TR_B:l,MA_B:m,CR_W:e,SQ_W:k,TR_W:h,MA_W:b,CR_E:e,SQ_E:k,TR_E:h,MA_E:b,TW:a,TB:c}},markCurrentMove:function(a){var c=this.boardSetting.gridWidth;
this.currentMoveMarker&&(this.currentMoveMarker.remove(),this.currentMoveMarker=null);a&&(a=this.coordinateManager.boardCoorToViewBoxCoor(a),this.currentMoveMarker=this.paper.circle(a.x,a.y,.15*c).attr({"stroke-width":0,fill:"red"}))},setMarker:function(a,c){var b="x"+a.x+"y"+a.y,d=this.pointStatusMap[b],e=null,f=null;d?(e=d.color,f=d.marker):(d={},this.pointStatusMap[b]=d);f&&(yogo.logWarn("point ("+a.x+","+a.y+") has a marker","setMarker"),d.markerElement.remove());b=null;b=c+"_"+(e||"E");if("TW"==
c||"TB"==c){if("W"==e&&"TW"==c||"B"==e&&"TB"==c)return;b=c}if(e=this.markerTemplates[b]){b=e.clone();e=this.coordinateManager.boardCoorToViewBoxCoor(a);if("CR"==c||"TW"==c||"TB"==c)b.attr({cx:e.x,cy:e.y});else if("SQ"==c){var g=b.getBBox();b.attr({x:e.x-g.width/2,y:e.y-g.height/2})}else b.getBBox(),b.transform("t"+(e.x-this.templateMarkerPoint.x)+","+(e.y-this.templateMarkerPoint.y));b.show();d.marker=c;d.markerElement=b;f||this.markerPoints.push(a)}else yogo.logError("markerTemplate "+b+" not found",
"setMarker")},setMarkers:function(a,c){for(var b=0;b<a.length;b++)this.setMarker(a[b],c)},removeMarker:function(a){var c=this.pointStatusMap["x"+a.x+"y"+a.y];c&&c.marker?(c.marker=null,c.markerElement.remove(),c.markerElement=null):yogo.logWarn("no marker at ("+a.x+","+a.y+")","removeMarker")},removeAllMarkers:function(){for(;0<this.markerPoints.length;)this.removeMarker(this.markerPoints.pop())}};
Board.Stone=function(a){this.board=a;this.boardSize=a.boardSize;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMap=a.pointStatusMap;this.coordinateManager=a.coordinateManager;this.stoneTemplates=this.setupStoneTemplates();this.moveNumberElements=[];this.currentMoveNumberElement=null};
Board.Stone.prototype={setupStoneTemplates:function(){var a=this.boardSetting.strokes,a=this.paper.circle(-this.boardSetting.gridWidth,-this.boardSetting.gridWidth,this.boardSetting.gridWidth/2-a.stoneSpacing).attr({"stroke-width":a.stone,fill:"black"});return{blackStone:a,whiteStone:a.clone().attr({fill:"white"})}},placeStone:function(a,c){if("B"!=c&&"W"!=c)yogo.logWarn("wrong color:"+c,"place stone");else{var b="x"+a.x+"y"+a.y,d=this.pointStatusMap[b];if(d&&d.color){yogo.logWarn("point occupied: ("+
a.x+","+a.y+",color:"+d.color+")","place stone");if(c==d.color)return;var e=d["stone"+("B"==c?"W":"B")];e&&e.hide()}d||(d={coor:a});d.color=c;if(e=d["stone"+c])e.show();else{var e=("B"==c?this.stoneTemplates.blackStone:this.stoneTemplates.whiteStone).clone(),f=this.coordinateManager.boardCoorToViewBoxCoor(a);e.attr({cx:f.x,cy:f.y});d["stone"+c]=e;this.pointStatusMap[b]=d}}},removeStone:function(a){var c=this.pointStatusMap["x"+a.x+"y"+a.y];if(c){var b=c["stone"+c.color];b?(b.hide(),c.moveNumberElement&&
(c.moveNumberElement.hide(),c.moveNumberElement=null)):yogo.logWarn("stone not exist: ("+a.x+","+a.y+")","remove stone");c.color=null}else yogo.logWarn("point empty: ("+a.x+","+a.y+")","remove stone")},addStones:function(a,c){for(var b=0;b<a.length;b++)this.placeStone(a[b],c)},removeStones:function(a){for(var c=0;c<a.length;c++)this.removeStone(a[c])},showMoveNumber:function(a){var c=this.pointStatusMap["x"+a.x+"y"+a.y];c&&c.color||yogo.logWarn("point empty: ("+a.x+","+a.y+")","show move number");
c.color!=a.color&&yogo.logWarn("wrong color: ("+a.x+","+a.y+")","show move number");var b=a.moveNumber,d=c["stone"+c.color],e=d.data("mn_"+b);if(e)a.current&&(this.unmarkCurrentMoveNumber(),e.attr({fill:"red"}),this.currentMoveNumberElement=e),e.show(),this.moveNumberElements.push(e);else{e="black";"B"==c.color&&(e="white");var f=e;a.current&&(e="red");var g=this.boardSetting.moveNumbers.fontSize;9<b?g-=1:99<b&&(g-=2);var k=this.coordinateManager.boardCoorToViewBoxCoor(a),e=this.paper.text(k.x,k.y,
b).attr({"font-size":g,fill:e});e.data("oriColor",f);d.data("mn_"+b,e);c.moveNumberElement=e;this.moveNumberElements.push(e);a.current&&(this.unmarkCurrentMoveNumber(),this.currentMoveNumberElement=e)}},unmarkCurrentMoveNumber:function(){if(this.currentMoveNumberElement){var a=this.currentMoveNumberElement.data("oriColor");this.currentMoveNumberElement.attr({fill:a});this.currentMoveNumberElement=null}},showMoveNumbers:function(a){for(var c=0;c<a.length;c++)this.showMoveNumber(a[c])},hideMoveNumbers:function(){for(;0<
this.moveNumberElements.length;)this.moveNumberElements.pop().hide()}};
function Game(a,c){this.board=a;this.gameModel=c;this.boardSize=c.boardSize;this.curNode=c.nodes[0];this.onPlayNode=null;this.nodeNavigator=new Game.NodeNavigator(this);yogo.exportFunctions.call(this,this.nodeNavigator,"gotoNextX gotoLastX gotoNode gotoBeginning gotoGameEnd fastFoward fastBackward goinBranch gotoVariationBegin gotoVariationEnd backFromVariation".split(" "));this.markersManager=new Game.Markers(this);yogo.exportFunctions.call(this,this.markersManager,"setCurrentNodeMarkers setMarkers setMarkCurrentMove setMarkBranchPoints markBranchPointsIfAny setShowMoveNumber hideMoveNumbers handleMoveNumbers".split(" "))}
Game.prototype={diffPosition:function(a,c){for(var b=[],d=[],e=[],f=0;f<this.boardSize;f++){var g=a[f],k=c[f];if(g!==k)for(var l=0;l<this.boardSize;l++){var h=g[l],m=k[l];if(h!==m&&(h||m)){var n=!1,p=!1;m?h?h.color!=m.color&&(p=n=!0):p=!0:n=!0;h={x:f,y:l};n&&b.push(h);p&&("B"==m.color?e.push(h):d.push(h))}}}return{stonesToRemove:b,stonesToAddB:e,stonesToAddW:d}},playNode:function(a){if(!a)return!1;var c=this.board,b=this.curNode,d=this.curNode=a;a=!0;if(d.status.positionBuilt){if(d==b)return!1;if(b.nextNode!=
d||d.status.capture||d.status.setup)b.previousNode!=d||b.status.capture||b.status.setup?(d=this.diffPosition(b.position,d.position),c.removeStones(d.stonesToRemove),c.addStones(d.stonesToAddB,"B"),c.addStones(d.stonesToAddW,"W")):(e=b.move.point)&&c.removeStone(e);else{var e=d.move.point;e&&c.placeStone(e,d.move.color)}}else a=(new Game.PositionBuilder(this,d)).buildPosition();this.setCurrentNodeMarkers();this.handleMoveNumbers(b);"function"===typeof this.onPlayNode&&this.onPlayNode.call(this);return a},
inRealGame:function(){return this.curNode.belongingVariation.realGame}};Game.Markers=function(a){this.game=a;this.board=a.board;this.markBranchPoints=this.markCurrentMove=!0;this.showMoveNumber=!1;this.showMoveNumberCount=10;this.hideMoveNumberTemporarily=!1};
Game.Markers.prototype={setCurrentNodeMarkers:function(){var a=this.board;a.removeAllMarkers();a.removeAllLabels();a.removeBranchPointLabels();var c=this.game.curNode;if(c.status.mark){c.marks.LB&&a.setLabels(c.marks.LB);for(var b="TR CR SQ MA TW TB".split(" "),d=0;d<b.length;d++){var e=b[d];c.marks[e]&&this.setMarkers(c.marks[e],e,!0)}}this.markBranchPoints&&this.markBranchPointsIfAny();this.markCurrentMove&&!this.showMoveNumber?a.markCurrentMove(c.move.point):a.markCurrentMove(null)},setMarkers:function(a,
c,b){var d=this.board;if(b)for(b=0;b<a.length;b++){var e=a[b];e.coorFrom?(e=yogo.evaluatePointRange(e.coorFrom,e.coorTo),d.setMarkers(e,c)):d.setMarker(e,c)}else d.setMarkers(a,c)},setMarkCurrentMove:function(a){(this.markCurrentMove=a)?this.board.markCurrentMove(this.game.curNode.move.point):this.board.markCurrentMove(null)},setMarkBranchPoints:function(a){(this.markBranchPoints=a)?this.markBranchPointsIfAny():this.board.removeBranchPointLabels()},markBranchPointsIfAny:function(){var a=this.game.curNode.branchPoints;
if(a)for(var c=0;c<a.length;c++)if(!(25<c)){var b=a[c],d=String.fromCharCode(65+c);this.board.setLabel(b,d,"branch_point")}},setShowMoveNumber:function(a){"boolean"===typeof a?(this.showMoveNumber=a,0==this.showMoveNumberCount&&(this.showMoveNumberCount=1)):"number"===typeof a?(this.showMoveNumberCount=a,this.showMoveNumber=0<a):"string"===typeof a&&(a=parseInt(a),NaN(a)||(this.showMoveNumberCount=a,this.showMoveNumber=0<a));this.showMoveNumber?this.board.markCurrentMove(null):this.board.markCurrentMove(this.game.curNode.move.point);
this.resetMoveNumbers()},resetMoveNumbers:function(){this.board.hideMoveNumbers();if(this.showMoveNumber){for(var a=[],c=this.showMoveNumberCount,b=this.game.curNode,d=b.belongingVariation,e=b.position;0<c;c--){var f=b.move.point;if(f){var g=e[f.x][f.y];g&&g.node===b&&(f={x:f.x,y:f.y,color:b.move.color,moveNumber:b.numbers.displayMoveNumber},b===this.game.curNode&&(f.current=!0),a.push(f))}if(!d.realGame&&(b.status.variationFirstNode||b.belongingVariation!==d))break;b=b.previousNode;if(!b)break}this.board.showMoveNumbers(a)}},
hideMoveNumbers:function(){this.board.hideMoveNumbers()},handleMoveNumbers:function(a){var c=this.board,b=this.game.curNode;if(b.status.mark)this.hideMoveNumberTemporarily=!0,this.hideMoveNumbers(),this.markCurrentMove&&c.markCurrentMove(b.move.point);else if(this.hideMoveNumberTemporarily)this.hideMoveNumberTemporarily=!1,this.resetMoveNumbers();else{var d=!1;if(0!==this.showMoveNumberCount&&!this.showMoveNumberCount){if(b.label&&a.nextNode==b){var e=b.belongingVariation;if(e.realGame||e==a.belongingVariation)(d=
b.move.point)?(e=b.numbers.displayMoveNumber,d={x:d.x,y:d.y,color:b.move.color,moveNumber:e,current:!0},c.showMoveNumber(d)):c.unmarkCurrentMoveNumber(),d=!0}if(a.previousNode==b&&(e=a.belongingVariation,e.realGame||e==b.belongingVariation)){if(d=b.move.point)e=b.numbers.displayMoveNumber,d={x:d.x,y:d.y,color:b.move.color,moveNumber:e,current:!0},c.showMoveNumber(d);d=!0}}d||this.resetMoveNumbers()}}};
function GameModel(){this.realGame=!0;this.nodes=[];this.variationMap={};this.nodeMap={};this.nodesByMoveNumber=[];this.gameEndingNode=this.id=null}GameModel.prototype={traverseNodes:function(a,c,b){for(var d=this.nodes,e=0;e<d.length;e++){var f=d[e];if(c&&!1===c.call(f,f,b))break;if(f=f.variations)for(var g=0;g<f.length;g++){var k=f[g];if(a&&!1===a.call(k,k,b))return b;k.traverseNodes(a,c,b)}}return b},selectNodes:function(a){return traverseNodes(null,function(c,b){a.call(c,c)&&b.push(c)},[])}};
function Variation(a,c){this.baseNode=a;this.parentVariation=c;this.realGame=!1;this.nodes=[];this.id=null}Variation.prototype={};Variation.prototype.traverseNodes=GameModel.prototype.traverseNodes;Variation.prototype.selectNodes=GameModel.prototype.selectNodes;function Node(a,c){this.previousNode=a;this.belongingVariation=c;this.props={};this.status={};this.id=null}Node.prototype={};
Game.NodeNavigator=function(a){this.game=a;this.gameModel=a.gameModel;a=[{name:"Node",predicate:function(){return!0}},{name:"Branch",predicate:function(a){return!!a.variations}},{name:"Remark",predicate:function(a){return a.status.remark}},{name:"Comment",predicate:function(a){return a.status.comment}},{name:"Marks",predicate:function(a){return a.status.mark}},{name:"Ko",predicate:function(a){a=a.status;return a.positionBuilt&&(a.startKo||a.ko)}},{name:"Capture",predicate:function(a){return a.status.positionBuilt&&
a.status.capture}},{name:"NotEvaluated",predicate:function(a){return!a.status.positionBuilt}}];for(var c=function(a,b){return function(){return a.call(this,b)}.bind(this)}.bind(this),b=0;b<a.length;b++){var d=a[b],e=d.predicate,f="next"+d.name,d="previous"+d.name;this.game[f]=this[f]=c(this.gotoNextX,e);this.game[d]=this[d]=c(this.gotoLastX,e)}};
Game.NodeNavigator.prototype={gotoNextX:function(a){for(var c=this.game.curNode;;){if(c.nextNode)c=c.nextNode;else if(c.variations)c=c.variations[0].nodes[0];else return!1;if(!c)return!1;if(a.call(c,c))return this.game.playNode(c)}},gotoLastX:function(a){for(var c=this.game.curNode;;){c=c.previousNode;if(!c)return!1;if(a.call(c,c))return this.game.playNode(c)}},gotoNode:function(a){var c;"string"===typeof a?c=this.gameModel.nodeMap[a]:"number"===typeof a?c=this.gameModel.nodesByMoveNumber[a]:a instanceof
Node&&(c=a);return c?this.game.playNode(c):!1},gotoBeginning:function(){return this.game.playNode(this.gameModel.nodes[0])},gotoGameEnd:function(){return this.game.playNode(this.gameModel.gameEndingNode)},fastFoward:function(a){a=a||10;for(var c=this.game.curNode;0<a;a--)if(c.nextNode)c=c.nextNode;else if(c.variations)c=c.variations[0].nodes[0];else break;return this.game.playNode(c)},fastBackward:function(a){a=a||10;for(var c=this.game.curNode;0<a;a--)if(c.previousNode)c=c.previousNode;else break;
return this.game.playNode(c)},goinBranch:function(a){var c=this.game.curNode.variations;if(c){var b;"number"===typeof a?b=c[a]:"string"===typeof a&&1==a.length&&(a=a.charCodeAt(0)-65,b=c[a]);if(b)return this.game.playNode(b.nodes[0])}return!1},gotoVariationBegin:function(){return this.game.inRealGame()||this.game.curNode.status.variationFirstNode?!1:this.gotoLastX(function(a){return a.status.variationFirstNode})},gotoVariationEnd:function(){return this.game.inRealGame()||this.game.curNode.status.variationLastNode?
!1:this.gotoNextX(function(a){return a.status.variationLastNode})},backFromVariation:function(){return this.game.inRealGame()?!1:this.game.playNode(this.game.curNode.belongingVariation.baseNode)}};Game.PositionBuilder=function(a,c){this.game=a;this.board=a.board;this.gameModel=a.gameModel;this.boardSize=a.gameModel.boardSize;this.curNode=c;this.basePosition=null;this.position=[]};
Game.PositionBuilder.prototype={getPointColor:function(a,c){var b=(this.position[a]||this.basePosition[a])[c];return b?b.color:null},setPointColor:function(a,c,b){var d=null;b&&(d={color:b,node:this.curNode});if(!this.position[a])for(this.position[a]=[],b=0;b<this.basePosition[a].length;b++)this.position[a][b]=this.basePosition[a][b];this.position[a][c]=d},getFinalPosition:function(){for(var a=0;a<this.boardSize;a++)this.position[a]||(this.position[a]=this.basePosition[a]);return this.position},setPointsStatus:function(a,
c){for(var b=0;b<a.length;b++){var d=a[b];this.setPointColor(d.x,d.y,c)}},getAdjacentPointsStatus:function(a){a=[{x:a.x-1,y:a.y},{x:a.x,y:a.y-1},{x:a.x+1,y:a.y},{x:a.x,y:a.y+1}];for(var c=this.boardSize,b=0;4>b;b++){var d=a[b],e=d.x,f=d.y;0<=e&&0<=f&&e<c&&f<c?d.color=this.getPointColor(e,f):a[b]=null}return a},traverseGroup:function(a,c,b){function d(a,k){var l="x"+a.x+"y"+a.y;if(!e[l]){var h=f.getAdjacentPointsStatus(a),m=b(a,h);if(!1===m)return!1;e[l]=!0;for(l=0;4>l;l++)if(m=h[l],null!=m&&m.color==
c&&k!==l&&(m=d(m,(k+2)%4),!1===m))return!1}}var e={},f=this;return d(a)},checkGroupLiberties:function(a,c){var b=[];return!1===this.traverseGroup(a,c,function(a,c){b.push(a);for(var f=0;4>f;f++){var g=c[f];if(null!=g&&null==g.color)return!1}})?{hasLiberty:!0}:{hasLiberty:!1,groupPoints:b}},removeStones:function(a,c){if(c)for(var b=0;b<a.length;b++){var d=a[b];d.coorFrom?(d=yogo.evaluatePointRange(d.coorFrom,d.coorTo),this.removeStones(d,!1)):(this.setPointColor(x,y,null),this.board.removeStone(d))}else this.setPointsStatus(a,
null),this.board.removeStones(a)},addStones:function(a,c,b){if(b)for(b=0;b<a.length;b++){var d=a[b];d.coorFrom?(d=yogo.evaluatePointRange(d.coorFrom,d.coorTo),this.addStones(d,c,!1)):(this.setPointColor(d.x,d.y,c),this.board.placeStone(d,c))}else this.setPointsStatus(a,c),this.board.addStones(a,c)},checkOpponentLiberties:function(a,c){for(var b=[],d=this.getAdjacentPointsStatus(a),e=0;4>e;e++){var f=d[e];f&&f.color==c&&(f=this.checkGroupLiberties(f,f.color),f.hasLiberty||(f=f.groupPoints,this.removeStones(f,
!1),b=b.concat(f)))}return b},evaluateMove:function(){var a=this.curNode,c=a.move.color,b=a.move.point;if(this.getPointColor(b.x,b.y))return yogo.logWarn("point occupied: ("+b.x+","+b.y+","+c+")","play move"),!1;this.board.placeStone(b,c);this.setPointColor(b.x,b.y,c);var d="B"==c?"W":"B",e=this.checkOpponentLiberties(b,d);if(0<e.length){if(1==e.length){var f=e[0],g=a.previousNode;if(g&&g.status.capture&&1==g.move.capturedStones.length){var k=g.move.capturedStones[0],l=g.move[d];if(l&&f.x==l.x&&f.y==
l.y&&b.x==k.x&&b.y==k.y)return yogo.logWarn("ko, cann't recapture immediately: ("+b.x+","+b.y+","+c+")","play move"),g.status.ko||(g.status.startKo=!0),!1}g&&g.previousNode&&g.previousNode.previousNode&&(g=g.previousNode.previousNode,g.status.capture&&1==g.move.capturedStones.length&&(k=g.move.capturedStones[0],(d=g.move[d])&&f.x==d.x&&f.y==d.y&&b.x==k.x&&b.y==k.y&&(a.status.ko=!0,g.status.ko||(g.status.startKo=!0),yogo.logInfo("ko: ("+b.x+","+b.y+","+c+")","play move"))))}a.status.capture=!0;a.move.capturedStones=
e;b=a.move.accumulatedCaptures;b={B:b.B,W:b.W};b[c]+=e.length;a.move.accumulatedCaptures=b}else if(!this.checkGroupLiberties(b,c).hasLiberty)return yogo.logWarn("is self capture? ("+b.x+","+b.y+","+c+")","play move"),this.setPointColor(b.x,b.y,null),this.board.removeStone(b),!1;return!0},buildPosition:function(){var a=!0,c=this.curNode;if(c.status.positionEvaluated)return a;var b=c.previousNode;if(b)b.status.positionBuilt||(new Game.PositionBuilder(this.game,b)).buildPosition(),this.basePosition=
b.position,c.move.accumulatedCaptures=b.move.accumulatedCaptures;else{this.basePosition=[];for(b=0;b<this.boardSize;b++)this.basePosition[b]=[];c.move.accumulatedCaptures={B:0,W:0}}c.status.move&&(a=this.evaluateMove());if(c.status.setup&&(c.setup.AB&&this.addStones(c.setup.AB,"B",!0),c.setup.AW&&this.addStones(c.setup.AW,"W",!0),c.setup.AE))for(var b=function(a){var b=this.getPointColor(a.x,a.y);b&&(d.push({x:a.x,y:a.y,color:b}),this.setPointColor(a.x,a.y,null),this.board.removeStone(a))},d=c.setup.aeRemovedStones=
[],e=c.setup.AE,f=0;f<e.length;f++){var g=e[f];if(g.coorFrom)for(var g=yogo.evaluatePointRange(g.coorFrom,g.coorTo),k=0;k<g.length;k++)b(g[k]);else b(g)}c.position=this.getFinalPosition();c.status.positionBuilt=!0;return a}};String.prototype.trim||(String.prototype.trim=function(){rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;return this.replace(rtrim,"")});
Array.prototype.indexOf||(Array.prototype.indexOf=function(a,c){var b;if(null==this)throw new TypeError("");var d=Object(this),e=d.length>>>0;if(0===e)return-1;b=+c||0;Infinity===Math.abs(b)&&(b=0);if(b>=e)return-1;for(b=Math.max(0<=b?b:e-Math.abs(b),0);b<e;){if(b in d&&d[b]===a)return b;b++}return-1});
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("");var c=Array.prototype.slice.call(arguments,1),b=this,d=function(){},e=function(){return b.apply(this instanceof d&&a?this:a,c.concat(Array.prototype.slice.call(arguments)))};d.prototype=this.prototype;e.prototype=new d;return e});
function SgfParser(){function a(a){var b={};for(groupName in a)for(var d=a[groupName].split(" "),e=0;e<d.length;e++)b[d[e]]=groupName;return b}this.gameInfoPropNameToGroup=a({root:"GM FF AP SZ CA ST",basic:"GN EV RO DT PC RE GC",rule:"HA KM RU TM OT",blackPlayer:"PB BR BS BT",whitePlayer:"PW WR WS WT",recorder:"US SO AP",misc:"CP ON AN"});this.nodePropNameToGroup=a({basic:"N C",setup:"AB AW AE",move:"B W BL WL PL MN OB OW KO FG V",remark:"GB GW UC DM TE BM DO IT HO",marks:"LB TR CR SQ MA SL TW TB AR LN",
inheritProps:"PM DD DW"});this.propNameToType=a({integer:"MN OB OW PM SZ HA ST","float":"V KM",bool:"DO IT KO",triple:"GB GW UC DM TE BM HO",point:"B W",lableList:"LB",pointList:"AB AW AE TR CR SQ MA SL AR LN TW TB DD VM",stringArray:""})}
SgfParser.prototype={parseSgf:function(a){function c(){g&&(f.props[g]=k,k=g=null)}var b=[],d=null,e,f,g,k,l=0;a=a.match(/[()\[\];\\]|[^()\[\];\\]*/g);for(var h="",m=0;m<a.length;m++){var n=a[m];"\\"==n?"inPropValue"==d?(n=a[++m],n.startsWith("\n")&&(n=n.substr(1)),h+=n):yogo.logError("unexpected token: \\","parse sgf"):"inPropValue"==d&&"]"!=n?h+=n:"("==n?(0==l?(e=new GameModel,b.push(e)):(c(),d=e,e=new Variation(f,d),d.realGame&&!f.variations?(e.realGame=!0,f.variations=[]):(e.realGame=!1,f.variations||
(f.variations=[])),f.variations.push(e)),h="",d=null,e.variationDepth=l,l++):")"==n?(c(),h="",l--,0>l?yogo.logError("dismatch parenthesis: )","parse sgf"):(f=e.baseNode,0==e.nodes.length&&(yogo.logWarn("empty variation!","parse sgf"),f.variations.pop()),e=e.parentVariation,d=null)):";"==n?(c(),h="",d=f,f=new Node(d,e),d&&d.belongingVariation===e&&(d.nextNode=f),d&&d.belongingVariation===e||(f.status.variationFirstNode=!0),e.nodes.push(f),d="inProp"):"["==n?d="inPropValue":"]"==n?("C"!=g&&(h=h.trim()),
k?k instanceof Array?k.push(h):k=[k,h]:k=h,h="",d="inProp"):"inProp"==d?(h+=n,h=h.trim(),""!=h&&(/[a-zA-Z0-9]+/.test(h)?(c(),g=h,h=""):yogo.logError("unexpected property name: "+h,"parse sgf"))):h+=n}return b},buildGoGameModel:function(a){for(var c=0;c<a.length;c++){var b=a[c];this.processGameInfo(b);var d=this;b.traverseNodes(null,function(a,c){a.basic||(a.basic={});a.move||(a.move={});var g=a.props;for(name in g){var k=d.nodePropNameToGroup[name];if(k){var l=g[name],l=d.propertyTypeConvert(l,d.propNameToType[name],
b.boardSize);a[k]||(a[k]={});a[k][name]=l}else d.gameInfoPropNameToGroup[name]?a.previousNode&&yogo.logWarn("game info not at the first node: "+name,"node"):yogo.logWarn("unknown property name: "+name,"node")}a.status.move=!(!a.move.W&&!a.move.B);a.status.pass=null===a.move.W||null===a.move;a.status.setup=!!a.setup;a.status.comment=!(!a.basic||!a.basic.C);a.status.remark=!!a.remark;a.status.mark=!!a.marks;a.nextNode||a.variations||(a.status.variationLastNode=!0);a.move.W&&a.move.B&&yogo.logWarn("both Black and White move in one node: B["+
a.props.B+"],W["+a.props.W+"]","node");a.status.move&&(a.move.color=a.move.B?"B":"W",a.move.point=a.move.W||a.move.B);delete a.props},{});b.traverseNodes(function(a,c){a.id="v"+c.seq++;b.variationMap[a.id]=a},function(a,c){var d=a.previousNode;d?(d=d.numbers,d=a.status.move||a.status.pass?[d.globalMoveNumber+1,d.displayMoveNumber+1,d.variationMoveNumber+1]:[d.globalMoveNumber,d.displayMoveNumber,d.variationMoveNumber]):d=a.status.move||a.status.pass?[1,1,1]:[0,0,0];a.numbers={globalMoveNumber:d[0],
displayMoveNumber:d[1],variationMoveNumber:d[2]};a.move.MN&&(a.numbers.displayMoveNumber=a.move.MN);a.status.variationFirstNode&&(a.numbers.variationMoveNumber=a.status.move||a.status.pass?1:0);if(a.variations){for(var d=a.variations,k=[],l=0;l<d.length;l++){var h=d[l].nodes[0];h.status.move&&k.push(h.move.B||h.move.W)}a.branchPoints=k}a.id="n"+c.seq++;b.nodeMap[a.id]=a;a.belongingVariation.realGame&&((d=a.numbers.globalMoveNumber)&&!b.nodesByMoveNumber[d]&&(b.nodesByMoveNumber[d]=a),a.nextNode||
a.variations||(b.gameEndingNode=a))},{seq:1E3})}},processGameInfo:function(a){function c(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=d[0];a[d[1]]=a[e];delete a[e]}}var b={};a.gameInfo=b;var d=a.nodes[0].props;d.GM&&"1"!==d.GM&&yogo.logError("unsupported game type: GM\x3d"+d.GM,"game info");d.SZ||yogo.logError("missing board size(SZ)","game info");for(name in d){var e=this.gameInfoPropNameToGroup[name];if(e){b[e]||(b[e]={});var f=d[name];this.propNameToType[name]&&(f=this.propertyTypeConvert(f,this.propNameToType[name],
a.boardSize));b[e][name]=f}else this.nodePropNameToGroup&&this.nodePropNameToGroup[name]||yogo.logWarn("unknown property name: "+name,"game info")}b.blackPlayer&&c(b.blackPlayer,[["PB","name"],["BR","rank"],["BS","species"],["BT","term"]]);b.whitePlayer&&c(b.whitePlayer,[["PW","name"],["WR","rank"],["WS","species"],["WT","term"]]);b=b.root.SZ;(isNaN(b)||5>b||51<b)&&yogo.logError("wrong board size(SZ)","game info");a.boardSize=b},parseCoordinate:function(a,c){if(!a.match(/^[a-z][a-z]$/i))return yogo.logWarn("wrong coordinate: "+
a,"node"),null;var b=a.charCodeAt(0),d=a.charCodeAt(1),b=97>b?26+b-65:b-97,d=97>d?26+d-65:d-97;return b>=c||d>=c?null:{x:b,y:d}},propertyTypeConvert:function(a,c,b){var d=a;if(c)if(0<=["lableList","pointList","stringArray"].indexOf(c)?a instanceof Array||(a=[a]):a instanceof Array&&(a=a[0]||""),"point"==c)a=""==a?null:this.parseCoordinate(a,b);else if("lableList"==c){c=[];for(d=0;d<a.length;d++){var e=a[d].split(":"),f=e[0];if(e=e[1])f=this.parseCoordinate(f,b),null!=f&&(f.label=e,c.push(f))}a=0<
c.length?c:null}else if("pointList"==c){c=[];for(d=0;d<a.length;d++)f=a[d],0<f.indexOf(":")?(e=f.split(":"),f=this.parseCoordinate(e[0],b),e=this.parseCoordinate(e[1],b),f&&e&&c.push({coorFrom:f,coorTo:e})):(f=this.parseCoordinate(f,b),null!=f&&c.push(f));a=0<c.length?c:null}else"triple"==c?a="2"==a?2:1:"bool"==c?a=!0:"integer"==c?(a=parseInt(a),isNaN(a)&&yogo.logWarn("can't parse to Integer: "+name+","+d,"node")):"float"==c?(a=parseFloat(a),isNaN(a)&&yogo.logWarn("can't parse to Float: "+name+","+
d,"node")):yogo.logWarn("to do: "+name,"node");return a}};SgfParser.parse=function(a){var c=new SgfParser;a=c.parseSgf(a);c.buildGoGameModel(a);return a};
yogo={log:function(a,c,b){if(window.console&&((b=window.console[b])||(b=window.console.log),b instanceof Function)){c||(c="yogo");try{b.call(window.console,c+":",a)}catch(d){}}},logInfo:function(a,c){yogo.log(a,c,"info")},logWarn:function(a,c){yogo.log(a,c,"warn")},logError:function(a,c){yogo.log(a,c,"error")},exportFunctions:function(a,c){for(var b=0;b<c.length;b++){var d=c[b],e=a[d];"function"!==typeof e?yogo.logWarn(d+" is not a function"):this[d]=e.bind(a)}},evaluatePointRange:function(a,c){for(var b=
[],d=c.x,e=a.y,f=c.y,g=a.x;g<=d;g++)for(var k=e;k<=f;k++)b.push({x:g,y:k});return b}};
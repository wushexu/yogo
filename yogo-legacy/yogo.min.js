function Board(a,b,c){this.boardContainer=a;"string"===typeof a&&(this.boardContainer=document.getElementById(a));c?(c.clear(),this.paper=c):this.paper=Raphael(a);"number"===typeof b?(this.boardSize=b,this.boardSetting=Board.getDefaultBoardSetting(this.boardSize)):"object"===typeof b&&(this.boardSetting=b,this.boardSize=this.boardSetting.boardSize);this.pointStatusMatrix=[];this.lineOrStarMatrix=[];for(a=0;a<this.boardSize;a++)this.pointStatusMatrix[a]=[];if(this.boardSetting.labels.eraseBoardLine)for(a=
0;a<this.boardSize;a++)for(this.lineOrStarMatrix[a]=[],b=0;b<this.boardSize;b++)this.lineOrStarMatrix[a][b]=[];this.centralPoint;this.zoomMode=null;this.reversed=!1;this.rotate90=0;this.coordinateManager=new Board.Coordinate(this);yogo.exportFunctions.call(this,this.coordinateManager,"drawCoordinate hideCoordinate showCoordinate boardCoorToViewBoxCoor setXCoordinateType setYCoordinateType coordinateStatus setFullCoordinate".split(" "));this.stoneManager=new Board.Stone(this);yogo.exportFunctions.call(this,
this.stoneManager,"placeStone removeStone addStones removeStones showMoveNumber showMoveNumbers hideMoveNumbers unmarkCurrentMoveNumber".split(" "));this.markerManager=new Board.Marker(this);yogo.exportFunctions.call(this,this.markerManager,["setMarker","setMarkers","removeMarker","removeAllMarkers","markCurrentMove"]);this.labelManager=new Board.Label(this);yogo.exportFunctions.call(this,this.labelManager,["setLabel","setLabels","removeLabel","removeAllLabels","removeBranchPointLabels"]);this.pointClickHandler=
function(a,b){yogo.logWarn("pointClickHandler not set","board")};this.pointMouseupHandler=function(a,b){yogo.logWarn("pointMouseupHandler not set","board")};var d=this;this._pointClickHandler=function(a){d.pointClickHandler(this.data("coor"))};this._pointMouseupHandler=function(a){if(1===a.which)return!1;d.pointMouseupHandler(this.data("coor"),a.which)}}
Board.prototype={drawBoard:function(){var a=this.boardSetting,b=this.paper;yogo.logInfo("viewBox size:"+a.viewBoxSize,"board");this.setViewBox();var c=a.boardOrigin,d=a.gridWidth,e=a.boardOuterEdge,f=c.x,c=c.y,g=d*(this.boardSize-1)/2;this.centralPoint={x:f+g,y:c+g};d=d*(this.boardSize-1)+2*e;b.rect(f-e,c-e,d,d).attr({"stroke-width":0,fill:"#DCB35C"});a.labels.eraseBoardLine?this._drawBoardLine():this._drawBoardLineSimple();this.drawCoordinate();this._drawBoardStars();this._setupMask()},_setupMask:function(){for(var a=
this.paper,b=this.boardSetting.gridWidth,c=this,d=this.coordinateManager,e=function(a){var b=this.data("coor");if(c.reversed||0<c.rotate90)b=d._reverseTransformCoor(b,!1);1===a.which?c.pointClickHandler(b):c.pointMouseupHandler(b,a.which)},f=function(a){if(1===a.which)return!1;e.call(this,a)},g=b/2,h=0;h<this.boardSize;h++)for(var l=0;l<this.boardSize;l++){var k={x:h,y:l},m=this.coordinateManager.boardCoorToViewBoxCoor(k),m=a.rect(m.x-g,m.y-g,b,b).attr({"stroke-width":0,fill:"white","fill-opacity":0});
m.data("coor",k);m.click(e);m.mouseup(f)}},_setElementEventHandler:function(a){a.click(this._pointClickHandler);a.mouseup(this._pointMouseupHandler)},clearBoard:function(){for(var a=0;a<this.pointStatusMatrix.length;a++)for(var b=this.pointStatusMatrix[a],c=0;c<b.length;c++){var d=b[c];d&&d.color&&this.removeStone({x:a,y:c})}this.removeAllMarkers();this.removeAllLabels();this.removeBranchPointLabels();this.hideMoveNumbers();this.markCurrentMove(null)},setViewBox:function(){var a=this.boardSetting.viewBoxSize,
b=this.coordinateManager.getOneAxisWidth(),c=this.coordinateManager.fullCoordinate;this.coordinateManager.show?c?this.paper.setViewBox(0,0,a,a):this.paper.setViewBox(0,0,a-b,a-b):c?this.paper.setViewBox(b,b,a-2*b,a-2*b):this.paper.setViewBox(b,b,a-b,a-b)},zoomBoard:function(a){this.zoomMode=a;var b=this.boardSetting.viewBoxSize,c=this.coordinateManager.getOneAxisWidth(),d=this.coordinateManager.show,e=this.coordinateManager.fullCoordinate;if(0>"TL TR BL BR".indexOf(a))this.setViewBox();else{var f=
0;e||(b-=c);d||(f=c,e&&(b-=c));c=(b-f+this.boardSetting.gridWidth)/2;"TL"===a?this.paper.setViewBox(f,f,c,c):"TR"===a?this.paper.setViewBox(b-c,f,c,c):"BL"===a?this.paper.setViewBox(f,b-c,c,c):"BR"===a&&this.paper.setViewBox(b-c,b-c,c,c)}},resize:function(){var a=this.boardContainer.offsetWidth;this.paper.setSize(a,a)},flipHorizontal:function(){this.reversed=!this.reversed;this.rotate90=(this.rotate90+(0===this.rotate90%2?1:3))%4;this._transform()},flipVertical:function(){this.reversed=!this.reversed;
this.rotate90=(this.rotate90+(0===this.rotate90%2?3:1))%4;this._transform()},rotateRight:function(){this.rotate90=(this.rotate90+1)%4;this._transform()},rotateLeft:function(){this.rotate90=(this.rotate90+3)%4;this._transform()},rotate180:function(){this.rotate90=(this.rotate90+2)%4;this._transform()},resetPerspective:function(){this.reversed=!1;this.rotate90=0;this._transform()},_transform:function(){var a=90*this.rotate90,b=this.reversed;this.paper.forEach(function(c){if(!0===c.data("boardElement")){var d=
c.data("onCoordinateChange");if("function"===typeof d)d.call(c);else{yogo.logWarn("do transform","_transform");var d="",e=this.centralPoint.x,f=this.centralPoint.y;if(b){var g=c.attr("x"),h=c.attr("y");if(g)var l=h-g,g=g-h,d=d+("t"+l+","+g),e=e-l,f=f-g;else yogo.logWarn("element no x attribute","_transform")}0<a&&(d+="r"+a+","+e+","+f+"r-"+a);c.transform(d)}}},this)}};
Board.Coordinate=function(a){this.board=a;this.boardSize=a.boardSize;this.boardSetting=a.boardSetting;this.paper=a.paper;this.setting=this.boardSetting.coordinate;this.fullCoordinate=this.setting.fullCoordinate;this.show=this.setting.show;this.xType=this.setting.xType;this.yType=this.setting.yType;this.drawed=!1;this.xCoordinateLabels1=[];this.yCoordinateLabels1=[];this.xCoordinateLabels2=[];this.yCoordinateLabels2=[];var b=this;this.onCircleCoordinateChange=function(){var a=this.data("coor"),a=b.boardCoorToViewBoxCoor(a);
this.attr({cx:a.x,cy:a.y})};this.onLabelCoordinateChange=function(){var a=this.data("coor");if(b.boardSetting.labels.eraseBoardLine){var d=this.data("lineOrStarElements");if(d){for(var e=0;e<d.length;e++)d[e].show();d=b._transformCoor(a,!1);d=b.board.lineOrStarMatrix[d.x][d.y];for(e=0;e<d.length;e++)d[e].hide();this.data("lineOrStarElements",d)}}a=b.boardCoorToViewBoxCoor(a);this.attr({x:a.x,y:a.y})};this.onCoordLabelCoordinateChange=function(){var a=this.data("coor"),a=b._transformCoor(a,!0);this.attr({x:a.x,
y:a.y})}};
Board.Coordinate.prototype={_transformCoor:function(a,b){var c=b?this.boardSetting.viewBoxSize:this.boardSize-1,d=a.x,e=a.y;this.board.reversed&&(d=e,e=a.x);for(var f=this.board.rotate90;0<f;){var g=e,e=d,d=c-g;f--}return{x:d,y:e}},_reverseTransformCoor:function(a,b){for(var c=b?this.boardSetting.viewBoxSize:this.boardSize-1,d=a.x,e=a.y,f=(4-this.board.rotate90)%4;0<f;){var g=e,e=d,d=c-g;f--}this.board.reversed&&(g=d,d=e,e=g);return{x:d,y:e}},boardCoorToViewBoxCoor:function(a){a=this._transformCoor(a,!1);
var b=this.boardSetting.boardOrigin,c=this.boardSetting.gridWidth;return{x:b.x+c*a.x,y:b.y+c*a.y}},generateCoordinateLabel:function(a,b){var c=""+(a+1);if("1"!==b)if(0<="aA⒜\ud83c\udd10ⓐⒶ".indexOf(b))26<=a&&("a"===b?b="A":"⒜"===b?b="\ud83c\udd10":"ⓐ"===b&&(b="Ⓐ"),a%=26),c=String.fromCharCode(b.charCodeAt(0)+a);else if("一"===b){var d="一二三四五六七八九十".split(""),c=d[a%10];9<a&&(d[0]=d[9],c=d[parseInt(a/10)-1]+c)}else 0<="①⑴⒈".indexOf(b)&&(a%=20,c=String.fromCharCode(b.charCodeAt(0)+a));return c},drawCoordinate:function(){if(this.show&&
!this.drawed){for(var a=this.boardSetting.gridWidth,b=this.boardSetting.boardOrigin,c=this.boardSetting.viewBoxSize,d=0;d<this.boardSize;d++){var e=b.x+a*d,f=this.setting.baseCoor,g=this._transformCoor({x:e,y:f},!0),h=this.generateCoordinateLabel(d,this.xType),h=this.paper.text(g.x,g.y,h).attr({"font-size":this.setting.fontSize});h.data({type:"coordinate",boardElement:!0,coor:g,onCoordinateChange:this.onCoordLabelCoordinateChange});this.xCoordinateLabels1.push(h);this.fullCoordinate&&(e=this._transformCoor({x:e,
y:c-f},!0),f=h.clone().attr({x:e.x,y:e.y}),f.data({type:"coordinate",boardElement:!0,coor:e,onCoordinateChange:this.onCoordLabelCoordinateChange}),this.xCoordinateLabels2.push(f))}for(d=0;d<this.boardSize;d++)e=this.setting.baseCoor,f=b.y+a*d,g=this._transformCoor({x:e,y:f},!0),h=this.generateCoordinateLabel(d,this.yType),h=this.paper.text(g.x,g.y,h).attr({"font-size":this.setting.fontSize}),h.data({type:"coordinate",boardElement:!0,coor:g,onCoordinateChange:this.onCoordLabelCoordinateChange}),this.yCoordinateLabels1.push(h),
this.fullCoordinate&&(e=this._transformCoor({x:c-e,y:f},!0),f=h.clone().attr({x:e.x,y:e.y}),f.data({type:"coordinate",boardElement:!0,coor:e,onCoordinateChange:this.onCoordLabelCoordinateChange}),this.yCoordinateLabels2.push(f));this.drawed=!0}},setXCoordinateType:function(a){if(this.xType!=a&&(this.xType=a,this.drawed))for(var b=0;b<this.boardSize;b++){var c=this.generateCoordinateLabel(b,a);this.xCoordinateLabels1[b].attr({text:c});this.fullCoordinate&&this.xCoordinateLabels2[b].attr({text:c})}},
setYCoordinateType:function(a){if(this.yType!=a&&(this.yType=a,this.drawed))for(var b=0;b<this.boardSize;b++){var c=this.generateCoordinateLabel(b,a);this.yCoordinateLabels1[b].attr({text:c});this.fullCoordinate&&this.yCoordinateLabels2[b].attr({text:c})}},redrawCoordinate:function(){for(;0<this.xCoordinateLabels1.length;)this.xCoordinateLabels1.pop().remove();for(;0<this.yCoordinateLabels1.length;)this.yCoordinateLabels1.pop().remove();for(;0<this.xCoordinateLabels2.length;)this.xCoordinateLabels2.pop().remove();
for(;0<this.yCoordinateLabels2.length;)this.yCoordinateLabels2.pop().remove();this.drawed=!1;this.drawCoordinate()},setFullCoordinate:function(a){a!==this.fullCoordinate&&(this.fullCoordinate=a,this.redrawCoordinate(),this.board.setViewBox())},showCoordinate:function(){if(!this.show)if(this.show=!0,this.board.setViewBox(),this.drawed)for(var a=0;a<this.boardSize;a++)this.xCoordinateLabels1[a].show(),this.yCoordinateLabels1[a].show(),this.fullCoordinate&&(this.xCoordinateLabels2[a].show(),this.yCoordinateLabels2[a].show());
else this.drawCoordinate()},hideCoordinate:function(){if(this.show){for(var a=0;a<this.boardSize;a++)this.xCoordinateLabels1[a].hide(),this.yCoordinateLabels1[a].hide(),this.fullCoordinate&&(this.xCoordinateLabels2[a].hide(),this.yCoordinateLabels2[a].hide());this.show=!1;this.board.setViewBox()}},coordinateStatus:function(){return{show:this.show,xType:this.xType,yType:this.yType}},getOneAxisWidth:function(){return this.setting.coordinatePadding+this.setting.coordinateWidth}};
Board.Label=function(a){this.board=a;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMatrix=a.pointStatusMatrix;this.coordinateManager=a.coordinateManager;this.lineOrStarMatrix=a.lineOrStarMatrix;this.labelPoints=[];this.branchPoints=[]};
Board.Label.prototype={setLabel:function(a,b,c){if(b)if(2<b.length&&(!/^\d+$/.test(b)||3!=b.length))yogo.logError("label too long: "+b,"setLabel");else{var d=this.pointStatusMatrix[a.x][a.y],e=null,f=null;d?(e=d.color,f=d.label):(d={},this.pointStatusMatrix[a.x][a.y]=d);f&&d.labelElement.remove();var g="black";"B"==e&&(g="white");"branch_point"===c&&(g="blue",e&&yogo.logWarn("branch point ("+a.x+","+a.y+") has a stone","setLabel"));var f=this.boardSetting.labels,h=f.fontSize;2==b.length?h-=1:3<=b.length&&
(h-=2);var l=this.coordinateManager.boardCoorToViewBoxCoor(a),g=this.paper.text(l.x,l.y,b).attr({"font-size":h,fill:g});g.data({type:"label",boardElement:!0,coor:{x:a.x,y:a.y},onCoordinateChange:this.coordinateManager.onLabelCoordinateChange});d.labelElement=g;d.label=b;"branch_point"===c?(this.branchPoints.push(a),g.data("branch",b)):this.labelPoints.push(a);if(!e&&f.eraseBoardLine){a=this.coordinateManager._transformCoor(a,!1);a=this.lineOrStarMatrix[a.x][a.y];for(b=0;b<a.length;b++)a[b].hide();
g.data("lineOrStarElements",a)}this.board._setElementEventHandler(g)}else yogo.logError("label missing: ("+a.x+","+a.y+")","setLabel")},setLabels:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.setLabel(c,c.label)}},removeLabel:function(a){if((a=this.pointStatusMatrix[a.x][a.y])&&a.label){var b=a.labelElement.data("lineOrStarElements");if(b)for(var c=0;c<b.length;c++)b[c].show();a.labelElement.remove();a.labelElement=null;a.label=null}},removeAllLabels:function(){for(;0<this.labelPoints.length;)this.removeLabel(this.labelPoints.pop())},
removeBranchPointLabels:function(){for(;0<this.branchPoints.length;)this.removeLabel(this.branchPoints.pop())}};Board.prototype._drawBoardLineSimple=function(){var a=this.boardSetting,b=this.paper,c=a.boardSize,d=a.boardOrigin,e=a.gridWidth,a=a.strokes,f=d.x,d=d.y;b.rect(f,d,e*(c-1),e*(c-1)).attr({"stroke-width":a.outerBorderLine});for(var g="",h="",l=0;l<c-2;l++)g+="M"+f+" "+(d+e+e*l)+"H"+(f+e*(c-1)),h+="M"+(f+e+e*l)+" "+d+"V"+(d+e*(c-1));b.path(g).attr({"stroke-width":a.borderLine});b.path(h).attr({"stroke-width":a.borderLine})};
Board.prototype._drawBoardLine=function(){for(var a=this.boardSetting,b=this.paper,c=this.lineOrStarMatrix,d=a.labels.eraseRadius,e=a.boardSize,f=a.boardOrigin,g=a.gridWidth,a=a.strokes,h=f.x,f=f.y,l=h+g*(e-1),k=f+g*(e-1),m=1;m<e-1;m++){var n=h+g*m,p=f+g*m,q=b.path("M"+h+" "+p+"h"+d).attr({"stroke-width":a.borderLine});c[0][m].push(q);q=b.path("M"+h+" "+(p-d)+"v"+2*d).attr({"stroke-width":a.outerBorderLine});c[0][m].push(q);q=b.path("M"+(l-d)+" "+p+"h"+d).attr({"stroke-width":a.borderLine});c[e-1][m].push(q);
p=b.path("M"+l+" "+(p-d)+"v"+2*d).attr({"stroke-width":a.outerBorderLine});c[e-1][m].push(p);p=b.path("M"+n+" "+f+"v"+d).attr({"stroke-width":a.borderLine});c[m][0].push(p);p=b.path("M"+(n-d)+" "+f+"h"+2*d).attr({"stroke-width":a.outerBorderLine});c[m][0].push(p);p=b.path("M"+n+" "+(k-d)+"v"+d).attr({"stroke-width":a.borderLine});c[m][e-1].push(p);n=b.path("M"+(n-d)+" "+k+"h"+2*d).attr({"stroke-width":a.outerBorderLine});c[m][e-1].push(n)}m=b.path("M"+(h+d)+" "+f+"h-"+d+"v"+d).attr({"stroke-width":a.outerBorderLine});
c[0][0].push(m);m=b.path("M"+(l-d)+" "+f+"h"+d+"v"+d).attr({"stroke-width":a.outerBorderLine});c[e-1][0].push(m);m=b.path("M"+h+" "+(k-d)+"v"+d+"h"+d).attr({"stroke-width":a.outerBorderLine});c[0][e-1].push(m);l=b.path("M"+(l-d)+" "+k+"h"+d+"v-"+d).attr({"stroke-width":a.outerBorderLine});c[e-1][e-1].push(l);for(l=1;l<e-1;l++)for(k=1;k<e-1;k++)m=h+g*l,n=f+g*k,m="M"+(m-d)+" "+n+"h"+2*d+"M"+m+" "+(n-d)+"v"+2*d,m=b.path(m).attr({"stroke-width":a.borderLine}),c[l][k].push(m);c=.5*g-d;if(!(.1>c)){for(k=
0;k<e;k++){m="";for(l=0;l<e-1;l++)m+="M"+(h+g*l+d)+" "+(f+g*k)+"h"+2*c;n=0==k||k==e-1?a.outerBorderLine:a.borderLine;b.path(m).attr({"stroke-width":n})}for(l=0;l<e;l++){m="";for(k=0;k<e-1;k++)m+="M"+(h+g*l)+" "+(f+g*k+d)+"v"+2*c;n=0==l||l==e-1?a.outerBorderLine:a.borderLine;b.path(m).attr({"stroke-width":n})}}};
Board.prototype._drawBoardStars=function(){for(var a=this.boardSetting,b=this.paper,c=a.gridWidth,d=a.strokes,e=a.boardOrigin,f=e.x,e=e.y,g=a.starPoints,h=0;h<g.length;h++){var l=g[h],k=b.circle(f+c*l.x,e+c*l.y,d.star).attr({fill:"black"});a.labels.eraseBoardLine&&this.lineOrStarMatrix[l.x][l.y].push(k)}};
Board.Marker=function(a){this.board=a;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMatrix=a.pointStatusMatrix;this.coordinateManager=a.coordinateManager;this.currentMoveMarker=null;this.markerPoints=[];this._templateMarkerPoint={x:-this.boardSetting.gridWidth,y:-this.boardSetting.gridWidth};this.markerTemplates=this.setupMarkerTemplates()};
Board.Marker.prototype={setupMarkerTemplates:function(){var a=this.paper,b=this.boardSetting.gridWidth,c=this.boardSetting.strokes,d=this._templateMarkerPoint,e=a.circle(d.x,d.y,.23*b).attr({"stroke-width":.1*b}),f=e.clone().attr({stroke:"white"}),g=.4*b,g=a.rect(d.x,d.y,g,g).attr({"stroke-width":0,fill:"white"}),h=g.clone().attr({fill:"black"}),d=a.circle(d.x,d.y,.13*b).attr({"stroke-width":.04*b,fill:"white"}),l=d.clone().attr({fill:"black"}),k=.32*b,m=.1*b,n=function(b,c){var d=a.path("M"+(b.x-
k/2)+" "+(b.y-k/2)+"l"+k+" "+k+"M"+(b.x-k/2)+" "+(b.y+k/2)+"l"+k+" "+-k);d.attr({"stroke-width":m,"stroke-linecap":"round"});return"W"===c||"E"===c?d:d.attr({stroke:"white"})},p=.5*b,q=p*Math.sin(Math.PI/3),r=p/2*Math.tan(Math.PI/6),b=function(b,d){var e=a.path("M"+(b.x-p/2)+" "+(b.y+r)+"h"+p+"l"+-p/2+" "+-q+"Z");e.attr({"stroke-width":c.borderLine,fill:"white"});return"B"===d?e:e.attr({"stroke-width":0,fill:"black"})};return{CR_B:f,CR_W:e,CR_E:e,SQ_B:g,SQ_W:h,SQ_E:h,MA_B:n,MA_W:n,MA_E:n,TR_B:b,TR_W:b,
TR_E:b,TW:d,TB:l}},markCurrentMove:function(a){var b=this.boardSetting.gridWidth;this.currentMoveMarker&&(this.currentMoveMarker.remove(),this.currentMoveMarker=null);if(a){var c=this.coordinateManager.boardCoorToViewBoxCoor(a);this.currentMoveMarker=this.paper.circle(c.x,c.y,.15*b).attr({"stroke-width":0,fill:"red"});this.currentMoveMarker.data({type:"marker",boardElement:!0,marker:"currentMoveMarker",coor:{x:a.x,y:a.y},onCoordinateChange:this.coordinateManager.onCircleCoordinateChange});this.board._setElementEventHandler(this.currentMoveMarker)}},
setMarker:function(a,b){var c=this.pointStatusMatrix[a.x][a.y],d=null,e=null;c?(d=c.color,e=c.marker):(c={},this.pointStatusMatrix[a.x][a.y]=c);e&&(yogo.logWarn("point ("+a.x+","+a.y+") has a marker","setMarker"),c.markerElement.remove());var f=null,g=b+"_"+(d||"E");if("TW"==b||"TB"==b){if("W"==d&&"TW"==b||"B"==d&&"TB"==b)return;g=b}var h=this.coordinateManager,l=h.boardCoorToViewBoxCoor(a),k=this.markerTemplates[g];k?("function"===typeof k?(f=k.call(this,l,d||"E"),f.data({onCoordinateChange:function(){var a=
this.data("vbCoor"),b=this.data("coor"),b=h.boardCoorToViewBoxCoor(b);f.transform("t"+(b.x-a.x)+","+(b.y-a.y))},vbCoor:l})):f=k.clone(),f.data({type:"marker",boardElement:!0,marker:b,coor:{x:a.x,y:a.y}}),this.board._setElementEventHandler(f),"CR"==b||"TW"==b||"TB"==b?(f.attr({cx:l.x,cy:l.y}),f.data({onCoordinateChange:h.onCircleCoordinateChange})):"SQ"==b?(d=f.getBBox(),f.attr({x:l.x-d.width/2,y:l.y-d.height/2}),f.data({onCoordinateChange:function(){var a=this.data("coor"),a=h.boardCoorToViewBoxCoor(a),
b=this.getBBox();this.attr({x:a.x-b.width/2,y:a.y-b.height/2})}})):"TR"!=b&&"MA"!=b&&(yogo.logWarn("do translate","setMarker"),f.translate(l.x-this._templateMarkerPoint.x,l.y-this._templateMarkerPoint.y)),f.show(),c.marker=b,c.markerElement=f,e||this.markerPoints.push(a)):yogo.logError("markerTemplate "+g+" not found","setMarker")},setMarkers:function(a,b){for(var c=0;c<a.length;c++)this.setMarker(a[c],b)},removeMarker:function(a){var b=this.pointStatusMatrix[a.x][a.y];b&&b.marker?(b.marker=null,
b.markerElement.remove(),b.markerElement=null):yogo.logWarn("no marker at ("+a.x+","+a.y+")","removeMarker")},removeAllMarkers:function(){for(;0<this.markerPoints.length;)this.removeMarker(this.markerPoints.pop())}};
Board.getDefaultBoardSetting=function(a){(isNaN(a)||5>a||51<a)&&yogo.logError("wrong board size: "+a,"board");var b=20,c=2,d=12,e=12,f=1,g=2*d+2*c+2*(e+f),h=b*(a-1)+g;if(19!=a)var g=18*b+g,l=h/g,h=g,b=b/l,c=c/l,f=f/l,d=d/l,e=e/l;var g=c+e+d+f,g={x:g,y:g},c={xType:"A",yType:"1",show:!0,fullCoordinate:!0,fontSize:b/2,coordinatePadding:f,coordinateWidth:e,baseCoor:c+e/2},e={outerBorderLine:.03*b,borderLine:b*(15>=a?.018:.025),star:.045*b,stone:.02*b,stoneSpacing:.01*b},f={fontSize:b/2+3,eraseBoardLine:!0,
eraseRadius:.3*b},l={fontSize:b/2+1},k=[];1==a%2&&k.push({x:(a-1)/2,y:(a-1)/2});15<=a&&(k.push({x:3,y:(a-1)/2}),k.push({x:a-4,y:(a-1)/2}),k.push({x:(a-1)/2,y:3}),k.push({x:(a-1)/2,y:a-4}));11<a?(k.push({x:3,y:3}),k.push({x:3,y:a-4}),k.push({x:a-4,y:3}),k.push({x:a-4,y:a-4})):8<=a&&11>=a&&(k.push({x:2,y:2}),k.push({x:2,y:a-3}),k.push({x:a-3,y:2}),k.push({x:a-3,y:a-3}));return{viewBoxSize:h,boardSize:a,starPoints:k,boardOrigin:g,gridWidth:b,boardOuterEdge:d,strokes:e,labels:f,coordinate:c,moveNumbers:l}};
Board.Stone=function(a){this.board=a;this.boardSize=a.boardSize;this.boardSetting=a.boardSetting;this.paper=a.paper;this.pointStatusMatrix=a.pointStatusMatrix;this.coordinateManager=a.coordinateManager;this.stoneTemplates=this.setupStoneTemplates();this.moveNumberElements=[];this.currentMoveNumberElement=null};
Board.Stone.prototype={setupStoneTemplates:function(){var a=this.boardSetting.strokes,a=this.paper.circle(-this.boardSetting.gridWidth,-this.boardSetting.gridWidth,this.boardSetting.gridWidth/2-a.stoneSpacing).attr({"stroke-width":a.stone,fill:"black"});return{blackStone:a,whiteStone:a.clone().attr({fill:"white",stroke:"#666"})}},placeStone:function(a,b){if("B"!=b&&"W"!=b)yogo.logWarn("wrong color:"+b,"place stone");else{var c=this.pointStatusMatrix[a.x][a.y];c||(c={});if(c.color){yogo.logWarn("point occupied: ("+
a.x+","+a.y+",color:"+c.color+")","place stone");if(b==c.color)return;var d=c["stone"+("B"==b?"W":"B")];d&&d.hide()}c.color=b;if(d=c["stone"+b])d.show();else{var d=("B"==b?this.stoneTemplates.blackStone:this.stoneTemplates.whiteStone).clone(),e=this.coordinateManager.boardCoorToViewBoxCoor(a);d.attr({cx:e.x,cy:e.y});c["stone"+b]=d;this.pointStatusMatrix[a.x][a.y]=c;d.data({type:"stone",boardElement:!0,coor:{x:a.x,y:a.y},onCoordinateChange:this.coordinateManager.onCircleCoordinateChange});this.board._setElementEventHandler(d)}}},
removeStone:function(a){var b=this.pointStatusMatrix[a.x][a.y];if(b){var c=b["stone"+b.color];c?(c.hide(),b.moveNumberElement&&(b.moveNumberElement.hide(),b.moveNumberElement=null)):yogo.logWarn("stone not exist: ("+a.x+","+a.y+")","remove stone");b.color=null}else yogo.logWarn("point empty: ("+a.x+","+a.y+")","remove stone")},addStones:function(a,b){for(var c=0;c<a.length;c++)this.placeStone(a[c],b)},removeStones:function(a){for(var b=0;b<a.length;b++)this.removeStone(a[b])},showMoveNumber:function(a){var b=
this.pointStatusMatrix[a.x][a.y];b&&b.color||yogo.logWarn("point empty: ("+a.x+","+a.y+")","show move number");b.color!=a.color&&yogo.logWarn("wrong color: ("+a.x+","+a.y+")","show move number");var c=a.moveNumber,d=b["stone"+b.color],e=d.data("mn_"+c);if(e)a.current&&(this.unmarkCurrentMoveNumber(),e.attr({fill:"red"}),this.currentMoveNumberElement=e),e.show(),this.moveNumberElements.push(e);else{e="black";"B"==b.color&&(e="white");var f=e;a.current&&(e="red");var g=this.boardSetting.moveNumbers.fontSize;
9<c?g-=1:99<c&&(g-=2);var h=this.coordinateManager.boardCoorToViewBoxCoor(a),e=this.paper.text(h.x,h.y,c).attr({"font-size":g,fill:e});e.data({type:"moveNumber",oriColor:f,boardElement:!0,coor:{x:a.x,y:a.y},onCoordinateChange:this.coordinateManager.onLabelCoordinateChange});d.data("mn_"+c,e);b.moveNumberElement=e;this.moveNumberElements.push(e);a.current&&(this.unmarkCurrentMoveNumber(),this.currentMoveNumberElement=e);this.board._setElementEventHandler(e)}},unmarkCurrentMoveNumber:function(){if(this.currentMoveNumberElement){var a=
this.currentMoveNumberElement.data("oriColor");this.currentMoveNumberElement.attr({fill:a});this.currentMoveNumberElement=null}},showMoveNumbers:function(a){for(var b=0;b<a.length;b++)this.showMoveNumber(a[b])},hideMoveNumbers:function(){for(;0<this.moveNumberElements.length;)this.moveNumberElements.pop().hide()}};
function Game(a,b){this.board=a;this.gameModel=b;this.boardSize=b.boardSize;this._initialNode=new Node(null,b);for(var c=[],d=0;d<this.boardSize;d++)c[d]=[];this._initialNode.position=c;this._initialNode.nextNode=this.gameModel.nodes[0];this.curNode=this._initialNode;this._nodeHistory=[];this._nodeHistoryMaxIndex=this._nodeHistoryIndex=-1;this.mode="view";this.autoPlayIntervalSeconds=1;this.board.pointClickHandler=this.onBoardClick.bind(this);this.board.pointMouseupHandler=this.onBoardMouseup.bind(this);
this.onNodeRemoved=this.onNodeChanged=this.onNodeCreated=this.onPlayNode=null;this.nodeNavigator=new Game.NodeNavigator(this);yogo.exportFunctions.call(this,this.nodeNavigator,"gotoNextX gotoLastX gotoNode gotoBeginning gotoGameEnd fastFoward fastBackward goinBranch gotoVariationBegin gotoVariationEnd backFromVariation".split(" "));this.markersManager=new Game.Markers(this);yogo.exportFunctions.call(this,this.markersManager,"setCurrentNodeMarkers setMarkers setMarkCurrentMove setMarkBranchPoints markBranchPointsIfAny resetMoveNumber setShowMoveNumber hideMoveNumbers handleMoveNumbers".split(" "));
this.editManager=new Game.EditManager(this);yogo.exportFunctions.call(this,this.editManager,["setEditMode"])}
Game.prototype={playNode:function(a,b){if(!a)return!1;var c=this.board,d=this.curNode,e=this.curNode=a,f=!0;if(e.status.positionBuilt){if(e==d)return!1;if(d.nextNode!=e||e.status.capture||e.isSetup())if(d.previousNode!=e||d.status.capture||d.isSetup()){var g=e.diffPosition(d);c.removeStones(g.stonesToRemove);c.addStones(g.stonesToAddB,"B");c.addStones(g.stonesToAddW,"W")}else(g=d.move.point)&&c.removeStone(g);else(g=e.move.point)&&c.placeStone(g,e.move.color)}else f=(new PositionBuilder(this.board,
this.gameModel,e)).buildPosition();this.setCurrentNodeMarkers();if("function"===typeof this.onPlayNode)this.onPlayNode();if(!b||!1!==b.nodeHistory)if(d==this._initialNode||d.nextNode!==e&&d.previousNode!==e)c=this._nodeHistoryIndex,c++,this._nodeHistory[c]=e,this._nodeHistoryMaxIndex=this._nodeHistoryIndex=c;return f},_historyVisit:function(a){if(0>a||a>this._nodeHistoryMaxIndex)return!1;var b=this._nodeHistory[a];if(this.gameModel.nodeMap[b.id])return this._nodeHistoryIndex=a,this.playNode(b,{nodeHistory:!1});
this._nodeHistory.splice(a,1);a--;this._nodeHistoryIndex=a;this._nodeHistoryMaxIndex--;return this._historyVisit(a)},historyGoback:function(){this._historyVisit(this._nodeHistoryIndex-1)},historyGoforward:function(){this._historyVisit(this._nodeHistoryIndex+1)},buildAllPositions:function(){var a=this.board,b=this.gameModel,c=[];this.gameModel.traverseNodes(function(d){!1===(new PositionBuilder(a,b,d,!0)).buildPosition()&&(c.push(d),yogo.logWarn("invalid, node "+d.id,"buildPosition"))});for(var d=
0;d<c.length;d++)yogo.logWarn("bad move: "+c[d].id,"game");return c},inRealGame:function(){return this.curNode.belongingVariation.realGame},nextMoveColor:function(){return this.curNode.nextMoveColor()},_boardClickView:function(a){(a=this.curNode.nextNodeAt(a))&&this.playNode(a)},_boardClickFindAMove:function(a){var b,c=this.gameModel.pointMovesMatrix[a.x][a.y];if(c){b=c[0];for(var d=1;d<c.length;d++){var e=c[d];if(e.move.globalMoveNumber<=this.curNode.move.globalMoveNumber)b=e;else break}}if(this.inRealGame())b&&
this.playNode(b);else if(c=this.curNode.findNodeInAncestors(function(b){if(b.belongingVariation.realGame)return!1;var c=b.position[a.x][a.y];return c?c.node===b:!1}))this.game.playNode(c);else{if(b&&(c=this.curNode.belongingVariation.realGameBaseNode(),b.move.globalMoveNumber<=c.move.globalMoveNumber)){this.playNode(b);return}(c=this.curNode.findNodeInSuccessors(function(b){var c=b.position[a.x][a.y];return c?c.node===b:!1}))&&this.playNode(c)}},onBoardClick:function(a,b){if("view"===this.mode)this._boardClickView(a);
else if("find-move"===this.mode)this._boardClickFindAMove(a);else if("auto-play"===this.mode)this.startAutoPlay();else if("edit"===this.mode)this.editManager.onBoardClick(a)},onBoardMouseup:function(a,b){if("edit"===this.mode)this.editManager.onBoardMouseup(a,b)},setMode:function(a){this.mode=a},passMove:function(){if("edit"!==this.mode)return!1;this.editManager.passMove()},removeLastNode:function(){if("edit"!==this.mode)return!1;this.editManager.removeLastNode()},setPlayFirst:function(a){if("edit"!==
this.mode)return!1;this.editManager.setPlayFirst(a)},startAutoPlay:function(){if(this.autoPlayHandler)return!1;var a;a=function(){this.nextNode()?this.autoPlayHandler=setTimeout(a,1E3*this.autoPlayIntervalSeconds):this.stopAutoPlay()}.bind(this);this.autoPlayHandler=setTimeout(a,1E3*this.autoPlayIntervalSeconds)},stopAutoPlay:function(){clearTimeout(this.autoPlayHandler);this.autoPlayHandler=null},setAutoPlayInterval:function(a){"string"===typeof a&&(a=parseFloat(a));"number"!==typeof a||isNaN(a)||
(this.autoPlayIntervalSeconds=a)}};
Game.getHandicapPoints=function(a,b){var c=4;13>a&&(c=3);var c=[[{x:c-1,y:c-1},{x:(a-1)/2,y:c-1},{x:a-c,y:c-1}],[{x:c-1,y:(a-1)/2},{x:(a-1)/2,y:(a-1)/2},{x:a-c,y:(a-1)/2}],[{x:c-1,y:a-c},{x:(a-1)/2,y:a-c},{x:a-c,y:a-c}]],d=[c[2][0],c[0][2]];if(2==b)return d;d.push(c[0][0]);if(3==b)return d;d.push(c[2][2]);if(4==b)return d;if(5==b)return d.push(c[1][1]),d;d.push(c[1][0]);d.push(c[1][2]);if(6==b)return d;if(7==b)return d.push(c[1][1]),d;d.push(c[0][1]);d.push(c[2][1]);if(8==b)return d;d.push(c[1][1]);
return d};Game.EditManager=function(a){this.game=a;this.board=a.board;this.gameModel=a.gameModel;this.editMode="play";this._lastLabelNode=this._lastLabel=this.modeParam=null};
Game.EditManager.prototype={setEditMode:function(a,b){this.editMode=a;this.modeParam=b;"label"===this.editMode&&(this._lastLabelNode=this._lastLabel=null)},onBoardClick:function(a){"play"===this.editMode?this.playMove(a):"setup"===this.editMode?this.setup(a):"label"===this.editMode?this.addLabel(a):"mark"===this.editMode&&this.addMarker(a)},onBoardMouseup:function(a,b){"play"===this.editMode&&3===b?this.removeLastNode():"setup"===this.editMode&&this.setup(a,3===b)},stillNewGame:function(){var a=this.game.curNode;
return a===this.gameModel.nodes[0]&&!a.status.move&&a.isVariationLastNode()},setPlayFirst:function(a){var b=this.game.curNode;("B"===b.move.color?"W":"B")==a?b.move.PL&&(b.move.PL=null):b.move.PL=a},passMove:function(){if("play"!==this.editMode)return!1;var a=this.game.curNode,b=a.nextMoveColor(),c=a.nextPass(b);if(c)return this.game.playNode(c),!1;a=new Node(a);a.status.pass=!0;a.move.color=b;return this._addNewNode(a)},playMove:function(a){var b=this.game.curNode,c=b.nextNodeAt(a);if(c)return this.game.playNode(c),
!1;if(b.position[a.x][a.y])return!1;var c=b.nextMoveColor(),d=this.stillNewGame()&&!b.isSetup()&&!b.move.PL;d||(createNewNode=!0,b=new Node(b));b.move.color=c;b.move[c]={x:a.x,y:a.y};b.move.point=b.move[c];b.status.move=!0;if(d){if(PositionBuilder.amendAddStone(this.game,b,a,c),b.setMoveNumber(),this.game.setCurrentNodeMarkers(),this.gameModel.indexNode(b),this.game.onNodeChanged)this.game.onNodeChanged(b)}else return this._addNewNode(b)},_addNewNode:function(a){var b=this.game.curNode,c=b.nextNode,
d=b.belongingVariation;a.belongingVariation=d;if(!(new PositionBuilder(this.board,this.gameModel,a,!0)).buildPosition())return!1;if(b.isVariationLastNode())b.nextNode=a,d.realGame&&(this.gameModel.gameEndingNode=a),d.nodes.push(a);else if(b.variations)d=new Variation(b,d),d.index=b.variations.length,b.variations.push(d),a.belongingVariation=d,d.nodes.push(a),b.setBranchPoints();else if(c){b.nextNode=null;b.variations=[];var e=new Variation(b,d);e.realGame=d.realGame;for(b.variations.push(e);c;){c.belongingVariation=
e;e.nodes.push(c);if(c.variations)for(var f=0;f<c.variations.length;f++)c.variations[f].parentVariation=e;c=c.nextNode}c=b.belongingVariation.nodes;f=c.indexOf(b);c.splice(f+1,e.nodes.length);d=new Variation(b,d);b.variations.push(d);a.belongingVariation=d;d.nodes.push(a);b.setBranchPoints()}a.setMoveNumber();this.gameModel.indexNode(a);a.status.alter=!0;a.alter={type:"new-node"};this.game.playNode(a);if(this.game.onNodeCreated)this.game.onNodeCreated(a);return!0},removeLastNode:function(){if("play"!==
this.editMode)return!1;var a=this.game.curNode;if(!a.isVariationLastNode())return!1;var b=a.previousNode,c=a.belongingVariation;if(!a.isVariationFirstNode()){if(b.nextNode=null,c.realGame&&(this.game.gameEndingNode=b),this.gameModel.unindexNode(a),this.game.playNode(b),this.game.onNodeRemoved)this.game.onNodeRemoved(a)}else if(a!==this.gameModel.nodes[0]||a.variations){var d=null,e=b.variations,f=b.belongingVariation,g=0==c.index;g&&(d=e[1]);var h=!1;2==e.length?(b.nextNode=e[g?1:0].nodes[0],b.variations=
null,b.branchPoints=null,h=!0):(e.splice(c.index,1),b.setBranchPoints());this.gameModel.unindexNode(a);if(g){!h&&0==d.index&&d.parentVariation.realGame&&(d.realGame=!0);for(var l=this.gameModel,c=function(a){a.setMoveNumber();a.belongingVariation.realGame&&(l.nodesByMoveNumber[a.move.variationMoveNumber]=a,a.isVariationLastNode()&&(l.gameEndingNode=a))},e=d.nodes[0];e;){h&&(e.belongingVariation=f);c.call(e,e);if(e.variations)for(g=0;g<e.variations.length;g++){var k=e.variations[g];k.parentVariation=
e.belongingVariation;var m=null;0==g&&e.belongingVariation.realGame&&(m=function(a){0==a.index&&a.parentVariation.realGame&&(a.realGame=!0)},m.call(k,k));k.traverseNodes(c,m)}e=e.nextNode}}this.game.playNode(b);if(this.game.onNodeRemoved)this.game.onNodeRemoved(a,d)}else if(a.status.move&&(PositionBuilder.amendRemoveStone(this.game,a),a.status.move=!1,a.move.point=null,a.move.color=null,this.board.markCurrentMove(null),this.game.onNodeChanged))this.game.onNodeChanged(a)},setup:function(a,b){var c=
this.game.curNode,d=c.position[a.x][a.y];if(d){if(d.node===c&&c.isSetup()){new PositionBuilder(this.board,this.gameModel,c);var d="W",e=yogo.removePoint(c.setup.AB,a);e||(e=yogo.removePoint(c.setup.AW,a),d="B");e&&PositionBuilder.amendRemoveStone(this.game,c,a);b&&(e="A"+d,c.setup[e]||(c.setup[e]=[]),c.setup[e].push({x:a.x,y:a.y}),PositionBuilder.amendAddStone(this.game,c,a,d));return!0}return!1}if("B"!==this.modeParam&&"W"!==this.modeParam)return!1;e=this.modeParam;b&&(e="B"==e?"W":"B");d=!1;if(c.status.alter&&
c.isSetup()||this.stillNewGame()){if(PositionBuilder.amendAddStone(this.game,c,a,e),!c.isSetup()&&this.game.onNodeChanged)this.game.onNodeChanged(c)}else c=new Node(c),d=!0;c.setup||(c.setup={});e="A"+e;c.setup[e]||(c.setup[e]=[]);c.setup[e].push({x:a.x,y:a.y});return d?this._addNewNode(c):!0},addLabel:function(a){var b=this.game.curNode;this._lastLabelNode!==b&&(this._lastLabel=null);var c;c=this._lastLabel?String.fromCharCode(this._lastLabel.charCodeAt(0)+1):this.modeParam;var d=b.marks&&b.marks.LB,
e=!1;d&&(e=yogo.removePoint(d,a));e?this.board.removeLabel(a):(b.marks||(b.marks={}),b.marks.LB||(d=b.marks.LB=[]),d.push({x:a.x,y:a.y,label:c}),this.board.setLabel(a,c),this._lastLabel=c,this._lastLabelNode=b);b.status.alter=!0;b.alter||(b.alter={type:"prop-changed"})},addMarker:function(a){var b=this.game.curNode,c=this.modeParam,d=b.marks&&b.marks[c],e=!1;d&&(e=yogo.removePoint(d,a));e?this.board.removeMarker(a):(b.marks||(b.marks={}),b.marks[c]||(d=b.marks[c]=[]),d.push({x:a.x,y:a.y}),this.board.setMarker(a,
c));b.status.alter=!0;b.alter||(b.alter={type:"prop-changed"})}};Game.Markers=function(a){this.game=a;this.board=a.board;this.markBranchPoints=this.markCurrentMove=!0;this.showMoveNumber=!1;this.showMoveNumberCount=10;this.hideMoveNumberTemporarily=this.moveNumberMod=!1};
Game.Markers.prototype={setCurrentNodeMarkers:function(){var a=this.board;a.removeAllMarkers();a.removeAllLabels();a.removeBranchPointLabels();var b=this.game.curNode;this.markCurrentMove&&!this.showMoveNumber?a.markCurrentMove(b.move.point):a.markCurrentMove(null);if(b.hasMarks()){b.marks.LB&&a.setLabels(b.marks.LB);for(var a="TR CR SQ MA TW TB".split(" "),c=0;c<a.length;c++){var d=a[c];b.marks[d]&&this.setMarkers(b.marks[d],d,!0)}}this.markBranchPoints&&this.markBranchPointsIfAny();this.handleMoveNumbers()},
setMarkers:function(a,b,c){var d=this.board;if(c)for(c=0;c<a.length;c++){var e=a[c];e.coorFrom?(e=yogo.evaluatePointRange(e.coorFrom,e.coorTo),d.setMarkers(e,b)):d.setMarker(e,b)}else d.setMarkers(a,b)},setMarkCurrentMove:function(a){(this.markCurrentMove=a)?this.board.markCurrentMove(this.game.curNode.move.point):this.board.markCurrentMove(null)},setMarkBranchPoints:function(a){(this.markBranchPoints=a)?this.markBranchPointsIfAny():this.board.removeBranchPointLabels()},markBranchPointsIfAny:function(){var a=
this.game.curNode.branchPoints;if(a)for(var b=0;b<a.length;b++)if(!(25<b)){var c=a[b];if(!(51<c.x)){var d=String.fromCharCode(65+b);this.board.setLabel(c,d,"branch_point")}}},setShowMoveNumber:function(a){"boolean"===typeof a?(this.showMoveNumber=a,0==this.showMoveNumberCount&&(this.showMoveNumberCount=1)):"number"===typeof a?(this.moveNumberMod=!1,this.showMoveNumberCount=a,this.showMoveNumber=0<a):"all"===a?(a=this.board.boardSize,this.showMoveNumberCount=a*a+100,this.showMoveNumber=!0):"string"===
typeof a&&("%"==a.charAt(0)&&(this.moveNumberMod=!0,a=a.substr(1)),a=parseInt(a),isNaN(a)||(this.showMoveNumberCount=a,this.showMoveNumber=0<a));this.showMoveNumber?this.board.markCurrentMove(null):this.board.markCurrentMove(this.game.curNode.move.point);this.showMoveNumbers()},showMoveNumbers:function(){if(this.showMoveNumber){var a=[],b=this.showMoveNumberCount,c;this.moveNumberMod&&(c=b,b=this.game.curNode.move.displayMoveNumber%c,0==b&&(b=c));for(var d=this.game.curNode,e=d.belongingVariation,
f=d.position;0<b;b--){var g=d.move.point;if(g){var h=f[g.x][g.y];h&&h.node===d&&(h=d.move.displayMoveNumber,this.moveNumberMod&&(h%=c,0==h&&(h=c)),g={x:g.x,y:g.y,color:d.move.color,moveNumber:h},d===this.game.curNode&&(g.current=!0),a.push(g))}if(!e.realGame&&d.isVariationFirstNode()&&0<d.belongingVariation.index)break;if(d.move.MN)break;d=d.previousNode;if(!d)break}this.board.hideMoveNumbers();this.board.showMoveNumbers(a)}else this.board.hideMoveNumbers()},hideMoveNumbers:function(){this.board.hideMoveNumbers()},
handleMoveNumbers:function(){this.game.curNode.hasMarks()?(this.hideMoveNumberTemporarily=!0,this.hideMoveNumbers()):(this.hideMoveNumberTemporarily&&(this.hideMoveNumberTemporarily=!1),this.showMoveNumbers())},resetMoveNumber:function(a){var b=this.game.curNode;if("undo"===a){if("undefined"===typeof b.move.MN)return;b.move.MN=null}else{"string"===typeof a&&(a=parseInt(a));a=a||1;if(b.move.MN===a)return;b.move.MN=a}b.resetMoveNumber();this.handleMoveNumbers()}};
Game.NodeNavigator=function(a){this.game=a;this.gameModel=a.gameModel;a=[{name:"Node",predicate:function(){return!0}},{name:"Branch",predicate:function(a){return!!a.variations}},{name:"Comment",predicate:Node.prototype.hasComment},{name:"CommentOrBranch",predicate:function(a){return a.hasComment()||!!a.variations}},{name:"Remark",predicate:Node.prototype.hasRemark},{name:"Marks",predicate:Node.prototype.hasMarks},{name:"Ko",predicate:function(a){a=a.status;return a.positionBuilt&&(a.startKo||a.ko)}},
{name:"Capture",predicate:function(a){return a.status.positionBuilt&&a.status.capture}},{name:"NotEvaluated",predicate:function(a){return!a.status.positionBuilt}}];for(var b=function(a,b){return function(){return a.call(this,b)}.bind(this)}.bind(this),c=0;c<a.length;c++){var d=a[c],e=d.predicate,f="next"+d.name,d="previous"+d.name;this.game[f]=this[f]=b(this.gotoNextX,e);this.game[d]=this[d]=b(this.gotoLastX,e)}};
Game.NodeNavigator.prototype={gotoNextX:function(a){return(a=this.game.curNode.findNodeInMainline(a))?this.game.playNode(a):!1},gotoLastX:function(a){return(a=this.game.curNode.findNodeInAncestors(a))?this.game.playNode(a):!1},gotoNode:function(a){var b;/^\d+$/.test(a)&&(a=parseInt(a));"string"===typeof a?b=this.gameModel.nodeMap[a]:"number"===typeof a?b=this.gameModel.nodesByMoveNumber[a]:a instanceof Node&&(b=a);return b?this.game.playNode(b):!1},gotoBeginning:function(){return this.game.playNode(this.gameModel.nodes[0])},
gotoGameEnd:function(){return this.game.playNode(this.gameModel.gameEndingNode)},fastFoward:function(a){a=a||10;for(var b=this.game.curNode;0<a;a--)if(b.nextNode)b=b.nextNode;else if(b.variations)b=b.variations[0].nodes[0];else break;return this.game.playNode(b)},fastBackward:function(a){a=a||10;for(var b=this.game.curNode;0<a;a--)if(b.previousNode)b=b.previousNode;else break;return this.game.playNode(b)},goinBranch:function(a){var b=this.game.curNode.variations;if(b){var c;"number"===typeof a?c=
b[a]:"string"===typeof a&&1==a.length&&(a=a.charCodeAt(0)-65,c=b[a]);if(c)return this.game.playNode(c.nodes[0])}return!1},gotoVariationBegin:function(){return this.game.inRealGame()||this.game.curNode.isVariationFirstNode()?!1:this.gotoLastX(function(a){return a.isVariationFirstNode()})},gotoVariationEnd:function(){return this.game.inRealGame()||this.game.curNode.isVariationLastNode()?!1:this.gotoNextX(function(a){return a.isVariationLastNode()})},backFromVariation:function(){return this.game.inRealGame()?
!1:this.game.playNode(this.game.curNode.belongingVariation.baseNode)}};PositionBuilder=function(a,b,c,d){this.board=a;this.gameModel=b;this.boardSize=b.boardSize;this.curNode=c;this.buildPositionOnly=d||!1;this.basePosition=null;this.position=[]};
PositionBuilder.prototype={getPointColor:function(a,b){var c=(this.position[a]||this.basePosition[a])[b];return c?c.color:null},setPointColor:function(a,b,c){var d=null;c&&(d={color:c,node:this.curNode});if(!this.position[a])for(this.position[a]=[],c=0;c<this.basePosition[a].length;c++)this.position[a][c]=this.basePosition[a][c];this.position[a][b]=d},getFinalPosition:function(){for(var a=0;a<this.boardSize;a++)this.position[a]||(this.position[a]=this.basePosition[a]);return this.position},setPointsStatus:function(a,
b){for(var c=0;c<a.length;c++){var d=a[c];this.setPointColor(d.x,d.y,b)}},getAdjacentPointsStatus:function(a){a=[{x:a.x-1,y:a.y},{x:a.x,y:a.y-1},{x:a.x+1,y:a.y},{x:a.x,y:a.y+1}];for(var b=this.boardSize,c=0;4>c;c++){var d=a[c],e=d.x,f=d.y;0<=e&&0<=f&&e<b&&f<b?d.color=this.getPointColor(e,f):a[c]=null}return a},traverseGroup:function(a,b,c){function d(a,h){var l="x"+a.x+"y"+a.y;if(!e[l]){var k=f.getAdjacentPointsStatus(a),m=c(a,k);if(!1===m)return!1;e[l]=!0;for(l=0;4>l;l++)if(m=k[l],null!=m&&m.color==
b&&h!==l&&(m=d(m,(h+2)%4),!1===m))return!1}}var e={},f=this;return d(a)},checkGroupLiberties:function(a,b){var c=[];return!1===this.traverseGroup(a,b,function(a,b){c.push(a);for(var f=0;4>f;f++){var g=b[f];if(null!=g&&null==g.color)return!1}})?{hasLiberty:!0}:{hasLiberty:!1,groupPoints:c}},removeStones:function(a,b){if(b)for(var c=0;c<a.length;c++){var d=a[c];d.coorFrom?(d=yogo.evaluatePointRange(d.coorFrom,d.coorTo),this.removeStones(d,!1)):(this.setPointColor(x,y,null),this.buildPositionOnly||this.board.removeStone(d))}else this.setPointsStatus(a,
null),this.buildPositionOnly||this.board.removeStones(a)},addStones:function(a,b,c){if(c)for(c=0;c<a.length;c++){var d=a[c];d.coorFrom?(d=yogo.evaluatePointRange(d.coorFrom,d.coorTo),this.addStones(d,b,!1)):(this.setPointColor(d.x,d.y,b),this.buildPositionOnly||this.board.placeStone(d,b))}else this.setPointsStatus(a,b),this.buildPositionOnly||this.board.addStones(a,b)},checkOpponentLiberties:function(a,b){for(var c=[],d=this.getAdjacentPointsStatus(a),e=0;4>e;e++){var f=d[e];f&&f.color==b&&(f=this.checkGroupLiberties(f,
f.color),f.hasLiberty||(f=f.groupPoints,this.removeStones(f,!1),c=c.concat(f)))}return c},evaluateMove:function(){var a=this.curNode,b=a.move.color,c=a.move.point;if(this.getPointColor(c.x,c.y))return yogo.logWarn("point occupied: ("+c.x+","+c.y+","+b+")","play move"),!1;this.buildPositionOnly||this.board.placeStone(c,b);this.setPointColor(c.x,c.y,b);var d="B"==b?"W":"B",e=this.checkOpponentLiberties(c,d);if(0<e.length){if(1==e.length){var f=e[0],g=a.previousNode;if(g&&g.status.capture&&1==g.move.capturedStones.length){var h=
g.move.capturedStones[0],l=g.move[d];if(l&&f.x==l.x&&f.y==l.y&&c.x==h.x&&c.y==h.y)return yogo.logWarn("ko, cann't recapture immediately: ("+c.x+","+c.y+","+b+")","play move"),g.status.ko||(g.status.startKo=!0),!1}g&&g.previousNode&&g.previousNode.previousNode&&(g=g.previousNode.previousNode,g.status.capture&&1==g.move.capturedStones.length&&(h=g.move.capturedStones[0],(d=g.move[d])&&f.x==d.x&&f.y==d.y&&c.x==h.x&&c.y==h.y&&(a.status.ko=!0,g.status.ko||a.belongingVariation.realGame!==g.belongingVariation.realGame||
(g.status.startKo=!0))))}a.status.capture=!0;a.move.capturedStones=e;c=a.move.accumulatedCaptures;c={B:c.B,W:c.W};c[b]+=e.length;a.move.accumulatedCaptures=c}else if(!this.checkGroupLiberties(c,b).hasLiberty)return yogo.logWarn("is self capture? ("+c.x+","+c.y+","+b+")","play move"),this.setPointColor(c.x,c.y,null),this.buildPositionOnly||this.board.removeStone(c),!1;return!0},buildPosition:function(){var a=!0,b=this.curNode;if(b.status.positionEvaluated)return a;var c=b.previousNode;if(c)c.status.positionBuilt||
(new PositionBuilder(this.board,this.gameModel,c)).buildPosition(),this.basePosition=c.position,b.move.accumulatedCaptures=c.move.accumulatedCaptures;else{this.basePosition=[];for(c=0;c<this.boardSize;c++)this.basePosition[c]=[];b.move.accumulatedCaptures={B:0,W:0}}b.status.move&&(a=this.evaluateMove());if(b.isSetup()&&(b.setup.AB&&this.addStones(b.setup.AB,"B",!0),b.setup.AW&&this.addStones(b.setup.AW,"W",!0),b.setup.AE))for(var d=b.setup.aeRemovedStones=[],c=b.setup.AE,e=function(a){var b=this.getPointColor(a.x,
a.y);b&&(d.push({x:a.x,y:a.y,color:b}),this.setPointColor(a.x,a.y,null),this.buildPositionOnly||this.board.removeStone(a))}.bind(this),f=0;f<c.length;f++){var g=c[f];if(g.coorFrom)for(var g=yogo.evaluatePointRange(g.coorFrom,g.coorTo),h=0;h<g.length;h++)e.call(this,g[h]);else e.call(this,g)}b.position=this.getFinalPosition();b.status.positionBuilt=!0;return a}};
PositionBuilder.amendAddStone=function(a,b,c,d){var e=b.position,f=c.x,g=c.y;if(e[f][g])yogo.logWarn("the point is not empty","amend");else{for(var h=e[f],l=[],k=0;k<h.length;k++)l[k]=h[k];l[g]={color:d,node:b};e[f]=l;a.board.placeStone(c,d)}};PositionBuilder.amendRemoveStone=function(a,b,c){var d=b.position;c=c||b.move.point;b=c.x;var e=c.y;if(d[b][e]){for(var f=d[b],g=[],h=0;h<f.length;h++)g[h]=f[h];g[e]=null;d[b]=g;a.board.removeStone(c)}else yogo.logWarn("the point is empty","amend")};
function GameModel(){this.realGame=!0;this.boardSize=null;this.nodes=[];this.gameInfo={};this.nodeMap={};this.nodesByMoveNumber=[];this.pointMovesMatrix=[];this.gameEndingNode=null}GameModel.newModel=function(a,b){var c=new GameModel;c.boardSize=a;for(var d=0;d<c.boardSize;d++)c.pointMovesMatrix[d]=[];d=new Node(null,c);c.indexNode(d);c.nodes[0]=d;c.gameEndingNode=d;if(b&&0<b.length){var e=c.gameInfo;e.rule={};e.rule.HA=b.length;d.setup={AB:b}}return c};
GameModel.prototype={indexNode:function(a){this.nodeMap[a.id]=a;if(a.belongingVariation.realGame){var b=a.move.point;if(b){var c=this.pointMovesMatrix[b.x],d=c[b.y];d?d.push(a):(d=[a],c[b.y]=d)}a.move.color&&(this.nodesByMoveNumber[a.move.variationMoveNumber]=a)}},unindexNode:function(a){this.nodeMap[a.id]=null;if(a.belongingVariation.realGame){var b=a.move.point;if(b&&(b=this.pointMovesMatrix[b.x][b.y])){var c=b.indexOf(a);0<=c&&b.splice(c,1)}a.move.color&&(this.nodesByMoveNumber[a.move.variationMoveNumber]=
null)}},traverseNodes:function(a,b,c){for(var d=this.nodes,e=0;e<d.length;e++){var f=d[e];if(a&&!1===a.call(f,f))break;if(f=f.variations)for(var g=0;g<f.length;g++){var h=f[g];if(b){var l=b.call(h,h);if(!1===l)return}h.traverseNodes(a,b,c);if(c&&(l=c.call(h,h),!1===l))return}}},selectNodes:function(a){var b=[];this.traverseNodes(function(c){a.call(c,c)&&b.push(c)});return b},findNode:function(a){var b=[];this.traverseNodes(function(c){var d=a.call(c,c);if(null===d)return!1;if(!0===d)return b.push(c),
!1});return b[0]||null}};function Variation(a,b){this.baseNode=a;this.parentVariation=b;this.realGame=!1;this.nodes=[];this.index=0;this.id="v"+yogo.nextuid()}
Variation.prototype={nextVariation:function(){var a=this.baseNode.variations,b=(this.index+1)%a.length;0==b&&(b=1);return a[b]},previousVariation:function(){var a=this.baseNode.variations,b=(this.index-1+a.length)%a.length;0==b&&(b=a.length-1);return a[b]},realGameBaseNode:function(){for(var a=this;a&&!a.realGame;){if(a.parentVariation.realGame)return a.baseNode;a=a.parentVariation}}};Variation.prototype.traverseNodes=GameModel.prototype.traverseNodes;Variation.prototype.selectNodes=GameModel.prototype.selectNodes;
Variation.prototype.findNode=GameModel.prototype.findNode;function Node(a,b){this.previousNode=a;this.belongingVariation=b;this.nextNode=null;this.props={};this.basic={};this.move={};this.status={};this.id="n"+yogo.nextuid();this.position=null;a||this.setMoveNumber()}
Node.prototype={isVariationFirstNode:function(){var a=this.previousNode;return!a||a.belongingVariation!==this.belongingVariation},isVariationLastNode:function(){return!this.nextNode&&!this.variations},isGameBegining:function(){var a=this.belongingVariation;return!this.previousNode&&a instanceof GameModel},isSetup:function(){return!!this.setup},hasComment:function(){return!(!this.basic||!this.basic.C)},hasMarks:function(){return!!this.marks},hasRemark:function(){return!!this.remark},findNodeInAncestors:function(a){for(var b=
this;;){b=b.previousNode;if(!b)return null;var c=a.call(b,b);if(null===c)return null;if(!0===c)return b}},findNodeInMainline:function(a){for(var b=this;;){if(b.nextNode)b=b.nextNode;else if(b.variations)b=b.variations[0].nodes[0];else return null;var c=a.call(b,b);if(null===c)return null;if(!0===c)return b}},findNodeInSuccessors:function(a){for(var b=this;;){if(b.nextNode)b=b.nextNode;else if(b.variations)for(var c=0;c<b.variations.length;c++){var d=b.variations[c].findNode(a);if(d)return d}else return null;
c=a.call(b,b);if(null===c)return null;if(!0===c)return b}},traverseSuccessorNodes:function(a,b){for(var c=this;;){if(c.nextNode)c=c.nextNode;else if(c.variations)for(var d=0;d<c.variations.length;d++){var e=c.variations[d];if(b&&!1===b.call(e,e,null))return!1;e=e.traverseNodes(a,b);if(!1===e)return!1}else return!0;e=a.call(c,c);if(!1===e)return!1}},nextNodeAt:function(a){var b=this.nextNode;if(b&&b.move.point){var c=b.move.point;return a.x===c.x&&a.y===c.y?b:null}if(this.branchPoints)for(b=0;b<this.branchPoints.length;b++)if(c=
this.branchPoints[b],a.x===c.x&&a.y===c.y)return this.variations[b].nodes[0];return null},nextPass:function(a){var b=this.nextNode;if(b&&b.status.pass)return b.move.color==a?b:null;if(this.variations)for(b=0;b<this.variations.length;b++){var c=this.variations[b].nodes[0];if(c.status.pass&&c.move.color==a)return c}return null},nextMoveColor:function(){var a;if(this.move.PL)a=this.move.PL;else if(this.move.color)a="B"===this.move.color?"W":"B";else if(this.isGameBegining()){var b=this.belongingVariation;
b.gameInfo.rule&&b.gameInfo.rule.HA&&(a="W")}a||(a="B");return a},setMoveNumber:function(){var a=this.status.move||this.status.pass,b;this.previousNode?(b=this.previousNode.move,b=[b.displayMoveNumber+(a?1:0),b.variationMoveNumber+(a?1:0)]):b=a?[1,1]:[0,0];this.move.displayMoveNumber=b[0];this.move.variationMoveNumber=b[1];b=this.belongingVariation;var c=b.realGame;this.isVariationFirstNode()&&!c&&0<b.index&&(this.move.displayMoveNumber=a?1:0,this.move.variationMoveNumber=a?1:0);this.move.MN&&(this.move.displayMoveNumber=
this.move.MN)},resetMoveNumber:function(){this.setMoveNumber();var a=this.belongingVariation;this.traverseSuccessorNodes(function(a){a.setMoveNumber()},function(b){if(b!==a&&0<b.index)return!1})},setBranchPoints:function(){if(this.variations){for(var a=this.variations,b=[],c=0;c<a.length;c++){var d=a[c];d.index=c;d=d.nodes[0];d.status.move?b.push(d.move.point):b.push({x:52,y:52})}this.branchPoints=b}},diffPosition:function(a){a=a.position;for(var b=this.position,c=[],d=[],e=[],f=a.length,g=0;g<f;g++){var h=
a[g],l=b[g];if(h!==l)for(var k=0;k<f;k++){var m=h[k],n=l[k];if(m!==n&&(m||n)){var p=!1,q=!1;n?m?m.color!=n.color&&(q=p=!0):q=!0:p=!0;m={x:g,y:k};p&&c.push(m);q&&("B"==n.color?e.push(m):d.push(m))}}}return{stonesToRemove:c,stonesToAddB:e,stonesToAddW:d}}};String.prototype.trim||(String.prototype.trim=function(){rtrim=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g;return this.replace(rtrim,"")});
Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){var c;if(null==this)throw new TypeError("");var d=Object(this),e=d.length>>>0;if(0===e)return-1;c=+b||0;Infinity===Math.abs(c)&&(c=0);if(c>=e)return-1;for(c=Math.max(0<=c?c:e-Math.abs(c),0);c<e;){if(c in d&&d[c]===a)return c;c++}return-1});
Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!==typeof this)throw new TypeError("");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){var e=this instanceof d&&a?this:a,g=b.concat(Array.prototype.slice.call(arguments));return c.apply(e,g)};d.prototype=this.prototype;e.prototype=new d;return e});function SgfExport(a){this.gameModel=a;this.app="yogo:0.5"}
SgfExport.prototype={_escape:function(a){return"string"!==typeof a?a:a.replace(/\\/g,"\\\\").replace(/]/g,"\\]")},_genProps:function(a,b){var c="";if(!a)return c;for(var d=0;d<b.length;d++){var e=b[d],f=a[e];if(f){if("C"===e||"GC"===e)c+="\n";f=this._escape(f);c+=e+"["+f+"]";c+="\n"}}return c},genGameInfoSgf:function(){var a=this.gameModel.gameInfo,b=a.root,c;c="GM[1]FF[4]"+("SZ["+this.gameModel.boardSize+"]");c=c+"CA[UTF-8]"+("AP["+this.app+"]\n");b&&b.ST&&(c+="ST["+b.ST+"]\n");if(b=a.blackPlayer)b.name&&
(c+="PB["+this._escape(b.name)+"]\n"),b.rank&&(c+="BR["+this._escape(b.rank)+"]\n"),b.species&&(c+="BS["+this._escape(b.species)+"]\n"),b.term&&(c+="BT["+this._escape(b.term)+"]\n");if(b=a.whitePlayer)b.name&&(c+="PW["+this._escape(b.name)+"]\n"),b.rank&&(c+="WR["+this._escape(b.rank)+"]\n"),b.species&&(c+="WS["+this._escape(b.species)+"]\n"),b.term&&(c+="WT["+this._escape(b.term)+"]\n");c+=this._genProps(a.basic,"GN EV RO DT PC RE GC".split(" "));c+=this._genProps(a.rule,["HA","KM","RU","TM","OT"]);
c+=this._genProps(a.recorder,["US","SO","AP"]);return c+=this._genProps(a.misc,["CP","ON","AN"])},toSgfCoordinate:function(a){var b=a.x;a=a.y;a=26>a?97+a:65+(a-26);return String.fromCharCode(26>b?97+b:65+(b-26))+String.fromCharCode(a)},_genPointsSgf:function(a,b){if(!b||0==b.length)return"";for(var c=a,d=0;d<b.length;d++){var e=b[d];if(e.coorFrom)var f=this.toSgfCoordinate(e.coorFrom),e=this.toSgfCoordinate(e.coorTo),c=c+("["+f+":"+e+"]");else f=this.toSgfCoordinate(e),c+="["+f+"]"}return c},geneNodeSgf:function(a){var b;
b=""+this._genProps(a.basic,["N"]);var c=a.move,d=c.color;if(c.point){var e=this.toSgfCoordinate(c.point);b+=d+"["+e+"]"}else d&&(b+=d+"[]");b+=this._genProps(c,"PL MN BL WL OB OW FG".split(" "));if(e=a.setup)for(c=0;3>c;c++)d=["AB","AW","AE"][c],e[d]&&(b+=this._genPointsSgf(d,e[d]));if(d=a.marks){for(var e="TR CR SQ MA TW TB".split(" "),f="",c=0;c<e.length;c++){var g=e[c],h=d[g];h&&(f+=this._genPointsSgf(g,h))}b+=f;if((d=d.LB)&&0<d.length){f="LB";for(c=0;c<d.length;c++)g=d[c],e=this.toSgfCoordinate(g),
f+="["+e+":"+g.label+"]";b+=f}}if(d=a.remark)for(e="GB GW UC DM TE BM DO IT HO".split(" "),c=0;c<e.length;c++)if(f=e[c],g=d[f])!0===g&&(g=1),b+=f+"["+g+"]";return b+=this._genProps(a.basic,["C"])},generateSgf:function(){var a=this.genGameInfoSgf(),b=this.gameModel.nodes[0],c=this,d="(";this.gameModel.traverseNodes(function(e){var f=c.geneNodeSgf(e);b===e&&(f=a+f);d+=";"+f},function(a){d+="("},function(a){d+=")"});d+=")";return d=d.replace(/\)\(/g,")\n(").replace(/\]\(/g,"]\n(")}};
function SgfParser(){function a(a){var c={};for(groupName in a)for(var d=a[groupName].split(" "),e=0;e<d.length;e++)c[d[e]]=groupName;return c}this.gameInfoPropNameToGroup=a({root:"GM FF AP SZ CA ST",basic:"GN EV RO DT PC RE GC",rule:"HA KM RU TM OT",blackPlayer:"PB BR BS BT",whitePlayer:"PW WR WS WT",recorder:"US SO AP",misc:"CP ON AN"});this.nodePropNameToGroup=a({basic:"N C",setup:"AB AW AE",move:"B W BL WL PL MN OB OW KO FG V",remark:"GB GW UC DM TE BM DO IT HO",marks:"LB TR CR SQ MA SL TW TB AR LN",
inheritProps:"PM DD DW"});this.propNameToType=a({integer:"MN OB OW PM SZ HA ST","float":"V KM",bool:"DO IT KO",triple:"GB GW UC DM TE BM HO",point:"B W",lableList:"LB",pointList:"AB AW AE TR CR SQ MA SL AR LN TW TB DD VM",stringArray:""})}
SgfParser.prototype={parseSgf:function(a){function b(){g&&(f.props[g]=h,h=g=null)}var c=[],d=null,e,f,g,h,l=0;a=a.match(/[()\[\];\\]|[^()\[\];\\]*/g);for(var k="",m=0;m<a.length;m++){var n=a[m];"\\"==n?"inPropValue"==d?(n=a[++m],n.startsWith("\n")&&(n=n.substr(1)),k+=n):yogo.logError("unexpected token: \\","parse sgf"):"inPropValue"==d&&"]"!=n?k+=n:"("==n?(0==l?(e=new GameModel,c.push(e)):(b(),d=e,e=new Variation(f,d),d.realGame&&!f.variations?(e.realGame=!0,f.variations=[]):(e.realGame=!1,f.variations||
(f.variations=[])),e.index=f.variations.length,f.variations.push(e)),k="",d=null,e.variationDepth=l,l++):")"==n?(b(),k="",l--,0>l?yogo.logError("dismatch parenthesis: )","parse sgf"):(f=e.baseNode,0==e.nodes.length&&(yogo.logWarn("empty variation!","parse sgf"),f.variations.pop()),e=e.parentVariation,d=null)):";"==n?(b(),k="",d=f,f=new Node(d,e),d&&d.belongingVariation===e&&(d.nextNode=f),e.nodes.push(f),d="inProp"):"["==n?d="inPropValue":"]"==n?("C"!=g&&(k=k.trim()),h?h instanceof Array?h.push(k):
h=[h,k]:h=k,k="",d="inProp"):"inProp"==d?(k+=n,k=k.trim(),""!=k&&(/[a-zA-Z0-9]+/.test(k)?(b(),g=k,k=""):yogo.logError("unexpected property name: "+k,"parse sgf"))):k+=n}return c},buildGoGameModel:function(a){for(var b=0;b<a.length;b++){var c=a[b];this.processGameInfo(c);for(var d=0;d<c.boardSize;d++)c.pointMovesMatrix[d]=[];var e=this;c.traverseNodes(function(a){var b=a.props;for(name in b){var d=e.nodePropNameToGroup[name];if(d){var l=b[name],l=e.propertyTypeConvert(l,e.propNameToType[name],c.boardSize);
a[d]||(a[d]={});a[d][name]=l}else e.gameInfoPropNameToGroup[name]?a.previousNode&&yogo.logWarn("game info not at the first node: "+name,"node"):yogo.logWarn("unknown property name: "+name,"node")}a.move.W&&a.move.B&&yogo.logWarn("both Black and White move in one node: B["+a.props.B+"],W["+a.props.W+"]","node");a.status.move=!(!a.move.W&&!a.move.B);a.status.pass=null===a.move.W||null===a.move;a.status.move?(a.move.point=a.move.W||a.move.B,a.move.color=a.move.B?"B":"W"):a.status.pass&&(a.move.color=
null===a.move.B?"B":"W");a.isVariationLastNode()&&a.belongingVariation.realGame&&(c.gameEndingNode=a)});c.traverseNodes(function(a){a.setMoveNumber();a.setBranchPoints();c.indexNode(a)})}},processGameInfo:function(a){function b(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=d[0];a[d[1]]=a[e];delete a[e]}}a.gameInfo||(a.gameInfo={});var c=a.gameInfo,d=a.nodes[0].props;d.GM&&"1"!==d.GM&&yogo.logError("unsupported game type: GM\x3d"+d.GM,"game info");d.SZ||yogo.logError("missing board size(SZ)","game info");
for(name in d){var e=this.gameInfoPropNameToGroup[name];if(e){c[e]||(c[e]={});var f=d[name];this.propNameToType[name]&&(f=this.propertyTypeConvert(f,this.propNameToType[name],a.boardSize));c[e][name]=f}else this.nodePropNameToGroup&&this.nodePropNameToGroup[name]||yogo.logWarn("unknown property name: "+name,"game info")}c.blackPlayer&&b(c.blackPlayer,[["PB","name"],["BR","rank"],["BS","species"],["BT","term"]]);c.whitePlayer&&b(c.whitePlayer,[["PW","name"],["WR","rank"],["WS","species"],["WT","term"]]);
c=c.root.SZ;(isNaN(c)||5>c||51<c)&&yogo.logError("wrong board size(SZ)","game info");a.boardSize=c},parseCoordinate:function(a,b){if(!a.match(/^[a-z][a-z]$/i))return yogo.logWarn("wrong coordinate: "+a,"node"),null;var c=a.charCodeAt(0),d=a.charCodeAt(1),c=97>c?26+c-65:c-97,d=97>d?26+d-65:d-97;return c>=b||d>=b?null:{x:c,y:d}},propertyTypeConvert:function(a,b,c){var d=a;if(b)if(0<=["lableList","pointList","stringArray"].indexOf(b)?a instanceof Array||(a=[a]):a instanceof Array&&(a=a[0]||""),"point"==
b)a=""==a?null:this.parseCoordinate(a,c);else if("lableList"==b){b=[];for(d=0;d<a.length;d++){var e=a[d].split(":"),f=e[0];if(e=e[1])f=this.parseCoordinate(f,c),null!=f&&(f.label=e,b.push(f))}a=0<b.length?b:null}else if("pointList"==b){b=[];for(d=0;d<a.length;d++)f=a[d],0<f.indexOf(":")?(e=f.split(":"),f=this.parseCoordinate(e[0],c),e=this.parseCoordinate(e[1],c),f&&e&&b.push({coorFrom:f,coorTo:e})):(f=this.parseCoordinate(f,c),null!=f&&b.push(f));a=0<b.length?b:null}else"triple"==b?a="2"==a?2:1:
"bool"==b?a=!0:"integer"==b?(a=parseInt(a),isNaN(a)&&yogo.logWarn("can't parse to Integer: "+name+","+d,"node")):"float"==b?(a=parseFloat(a),isNaN(a)&&yogo.logWarn("can't parse to Float: "+name+","+d,"node")):yogo.logWarn("to do: "+name,"node");return a}};SgfParser.parse=function(a){var b=new SgfParser;a=b.parseSgf(a);b.buildGoGameModel(a);return a};
function GameViewer(a){this.$v=$(a);0==this.$v.length?yogo.logWarn("no game viewer by this selector: "+a,"game viewer"):1<this.$v.length&&(yogo.logWarn("more than one game viewer by this selector: "+a,"game viewer"),this.$v=$(this.$v.get(0)));this._lastWheelTS=this.gameTree=this.game=this.gameModel=this.board=null}
GameViewer.prototype={init:function(a){var b=this,c=this.$v;$("button.paste-sgf",c).click(function(){$(".paste-sgf-container",c).show();$("textarea.sgf-text",c).get(0).select()});$("button.parse-sgf",c).click(function(){var a=$("textarea.sgf-text",c).val();a.trim()&&(b.loadGameFromSgfText(a),$(".paste-sgf-container",c).hide())});$("button.parse-sgf-cancel",c).click(function(){$(".paste-sgf-container",c).hide()});$("button.export-sgf",c).click(function(){$(".export-sgf-container",c).show();if(b.gameModel){var a=
(new SgfExport(b.gameModel)).generateSgf();$("textarea.export-sgf-text").val(a).get(0).select()}});$("button.export-sgf-cancel",c).click(function(){$(".export-sgf-container",c).hide()});$("button.node-history",c).click(function(){if(b.game){var a=$(this).data("value");"goback"===a?b.game.historyGoback():"goforward"===a&&b.game.historyGoforward()}});$("button.new-game",c).click(function(){var a=$("input.new-game-size",c).val(),d=$("input.new-game-handicap",c).val();b.newGame(a,d)});$("button.perspective",
c).click(function(){if(b.board){var a=$(this).data("value"),a=b.board[a];"function"===typeof a&&a.call(b.board)}});$("button.node-finder",c).click(function(){if(b.game){var a=$(this).data("navi"),a=b.game[a];"function"===typeof a&&a.call(b.game)}});$("input.game-op-mode",c).click(function(){if(b.game){var a=$(this).val();b.game.setMode(a);"auto-play"===a?b.game.startAutoPlay():b.game.stopAutoPlay()}});$("input.game-edit-mode",c).click(function(){if(b.game){var a=$(this).val(),c=$(this).data("param");
b.game.setEditMode(a,c)}});$("button.play-mode",c).click(function(){if(b.game){var a=$(this).data("value");"pass"==a?b.game.passMove():"cancel-latest"==a?b.game.removeLastNode():"black-first"==a?b.game.setPlayFirst("B"):"white-first"==a&&b.game.setPlayFirst("W")}});$("button.auto-play",c).click(function(){if(b.game){var a=$(this).data("value");"start"==a?b.game.startAutoPlay():"stop"==a&&b.game.stopAutoPlay()}});$("input.auto-play-interval",c).change(function(){b.game&&b.game.setAutoPlayInterval(this.value)});
$("button.goto-node",c).click(function(){if(b.game){var a=$(".move-number-input",c).val();b.game.gotoNode(a)}});$("input.move-number-input",c).keydown(function(a){b.game&&13==a.keyCode&&(b.game.gotoNode(this.value),this.blur())});$(".branch-select",c).on("click","button.branch",function(){var a=$(this).data("branch");b.game.goinBranch(a)});$("button.coordinate",c).click(function(){var a=b.board;if(a){var c=$(this).data("type");"show"===c||!0===c?a.showCoordinate():"hide"===c||!1===c?a.hideCoordinate():
(c=""+c,0<=c.indexOf(",")?(c=c.split(","),c[0]&&a.setXCoordinateType(c[0]),c[1]&&a.setYCoordinateType(c[1])):(a.setXCoordinateType(c),a.setYCoordinateType(c)))}});$("button.move-number",c).click(function(){var a=b.game;if(a){var c=$(this).data("value");!0===c||"true"===c?a.setShowMoveNumber(!0):!1===c||"false"===c?a.setShowMoveNumber(!1):a.setShowMoveNumber(c)}});$("button.reset-move-number",c).click(function(){var a=b.game;if(a){var c=$(this).data("value");a.resetMoveNumber(c)}});$("button.mark-current-move",
c).click(function(){if(b.game){var a=$(this).data("value");"true"===a?a=!0:"false"===a&&(a=!1);b.game.setMarkCurrentMove(a)}});$("button.zoom",c).click(function(){if(b.board){var a=$(this).data("zoom");"reset"==a&&(a=null);b.board.zoomBoard(a)}});var d=$(".game-tree-container",c);d.on("click","li.node-group-head, li.variation-head",function(){$(this).next().toggle(200)}).on("click","li.tree-node",function(){b.game.gotoNode(this.id)});$("button.collapse-nodes",d).click(function(){$("ul.tree-nodes:visible",
d).hide(200)});$("button.show-current-node",d).click(function(){b.gameTree&&b.game&&b.gameTree.showNode(b.game.curNode.id,!0)});$("select.node-group-count",d).change(function(){b.gameTree&&b.game&&b.gameTree.setGroupMoveCount($(this).val())});this._handlerFullscreen()},_handlerFullscreen:function(){var a=this,b=this.$v,c,d;$(document).on("fullscreenchange webkitfullscreenchange mozfullscreenchange fullscreenchange msfullscreenchange",function(b){b=document.webkitIsFullScreen;"undefined"===typeof b&&
(b=document.mozFullScreen);if(!0===b){if(c=document.webkitFullscreenElement,c||(c=document.mozFullScreenElement),c||(c=document.msFullscreenElement),b=$(c),b.is(".board-container")){var f=$(window).width(),g=$(window).height();g<f&&(f=g);b.width(f).height(f)}}else!1===b&&c&&(b=$(c),b.is(".board-container")&&(f=b.data("width"),g=b.data("height"),b.width(f).height(g)),c=null,d?a.board.showCoordinate():a.board.hideCoordinate())});$("button.fullscreen",b).click(function(){if(a.board){var b,c=$(this).data("value");
"board"===c?b=a.board.boardContainer:"viewer"===c&&(b=a.$v.get(0));b&&(b.requestFullscreen?b.requestFullscreen():b.msRequestFullscreen?b.msRequestFullscreen():b.mozRequestFullScreen?b.mozRequestFullScreen():b.webkitRequestFullscreen&&b.webkitRequestFullscreen(),"board"===c&&(d=a.board.coordinateStatus().show,a.board.hideCoordinate()))}})},onPlayNode:function(){var a=this.$v,b=this.game.curNode,c="";b.basic.C&&(c=b.basic.C);$(".comment-box",a).text(c);c="";if(b.remark)for(var d=[[["GB","Good for Black"],
["GW","Good for White"]],[["UC","Unclear Position"],["DM","Even Position"]],[["TE","Tesuji"],["BM","Bad Move"]],[["DO","Doubtful"],["IT","Interesting"]],[["HO","Hotspot"]]],e=b.remark,f=0;f<d.length;f++)for(var g=d[f],h=0;h<g.length;h++){var l=g[0],k=l[1];if(l=e[l[0]]){""!=c&&(c+="  ");c+=k;c=2==l?c+"!":c+".";break}}$(".remark",a).text(c);c=b.move.accumulatedCaptures;$(".play-status .black-capture",a).text(c.B);$(".play-status .white-capture",a).text(c.W);$(".branch-select",a).hide().find("button.branch").hide();
if(b.variations){for(c=b.belongingVariation.realGame?1:0;c<b.variations.length;c++)d=String.fromCharCode(65+b.variations[c].index),e=$(".branch-select button.branch"+d),0<e.length?e.show():$(".branch-select",a).append('\x3cbutton class\x3d"branch branch'+d+'" data-branch\x3d"'+d+'"\x3e'+d+"\x3c/button\x3e");$(".branch-select",a).show()}b.belongingVariation.realGame?$(".in-branch",a).hide():$(".in-branch",a).show();this.gameTree&&this.gameTree.showNode(b.id)},_initGame:function(){this.setPlayStatus();
this.setGameInfo();this.setupGame();this.setupGameTree();this.bindKeyAndWheelEvent();this.game.onPlayNode=this.onPlayNode.bind(this);this.game.onNodeCreated=this.onNodeCreated.bind(this);this.game.onNodeChanged=this.onNodeChanged.bind(this);this.game.onNodeRemoved=this.onNodeRemoved.bind(this);this.game.gotoBeginning()},newGame:function(a,b){a&&(a=parseInt(a),isNaN(a)||(5>a?a=5:23<a&&(a=23)));a=a||19;0==a%2&&(a+=1);var c=null;b&&(b=parseInt(b),isNaN(b)||(2>b?b=null:9<b&&(b=9)),b&&(c=Game.getHandicapPoints(a,
b)));c=this.gameModel=GameModel.newModel(a,c);this.setupBoard();this._initGame();this.gameTree&&this.gameTree.showNode(c.nodes[0].id);$("input.game-op-mode[value\x3dedit]",this.$v).click()},loadGameFromSgfText:function(a){if(this.gameModel=SgfParser.parse(a)[0])this.setupBoard(),this._initGame(),$("input.game-op-mode[value\x3dview]",this.$v).click()},setupBoard:function(){var a=this.$v;if(this.gameModel)if(this.board&&this.board.boardSize===this.gameModel.boardSize)this.board.clearBoard();else{var b=
this.game&&this.game.board.paper,a=$(".board-container",a);a.data("width",a.width());a.data("height",a.height());a.bind("contextmenu",function(){return!1});this.board=new Board(a.get(0),this.gameModel.boardSize,b);this.board.drawBoard()}},setupGame:function(){this.game=new Game(this.board,this.gameModel);this.game.buildAllPositions();$("input.auto-play-interval",this.$v).change()},setPlayStatus:function(){var a=$(".play-status",this.$v),b=this.gameModel.gameInfo,c=b.blackPlayer,b=b.whitePlayer,d=
"";c&&(d=c.name,c.rank&&(d=d+" "+c.rank));$(".black-player-name",a).text(d);d="";b&&(d=b.name,b.rank&&(d=d+" "+b.rank));$(".white-player-name",a).text(d)},setGameInfo:function(){for(var a=$(".game-info",this.$v),b=this.gameModel.gameInfo,c=0;2>c;c++){var d=0==c?"black":"white",e=b[d+"Player"];e&&(d=$("."+d+"-player",a),$(".name",d).text(e.name||""),$(".rank",d).text(e.rank||""),$(".species",d).text(e.species||""),$(".term",d).text(e.term||""))}c=b.basic||{};$(".game-name",a).text(c.GN||"");$(".event",
a).text(c.EV||"");$(".round",a).text(c.RO||"");$(".game-date",a).text(c.DT||"");$(".place",a).text(c.PC||"");c=c.RE||"";$(".game-result",a).text(c);c=b.rule||{};$(".handicap",a).text(c.HA||"");$(".komi",a).text(c.KM||"");$(".time-limit",a).text(c.TM||"");$(".byo-yomi",a).text(c.OT||"");c=b.recorder||{};$(".user",a).text(c.US||"");$(".source",a).text(c.SO||"");$(".app",a).text(c.AP||"");b=b.misc||{};$(".annotate-by",a).text(b.ON||"");$(".game-comment",a).text(b.CP||"");$(".copyright",a).text(b.AN||
"")},setupGameTree:function(){var a=$(".game-tree-container",this.$v);this.gameTree=new GameTree(a,this.game);a=$("select.node-group-count",a).val();parseInt(a)&&(this.gameTree.groupMoveCount=a);this.gameTree.setup()},bindKeyAndWheelEvent:function(){$("body").bind("keydown",this.keydownHandler.bind(this));var a=this.mousewheelHandler.bind(this);$(".board-container").bind("mousewheel DOMMouseScroll",a)},onNodeCreated:function(a){this.gameTree&&this.gameTree.addNode(a)},onNodeChanged:function(a){this.gameTree&&
this.gameTree.changeNodeInfo(a)},onNodeRemoved:function(a,b){this.gameTree&&this.gameTree.removeLastNode(a,b)}};
function GameTree(a,b){this.$container=a;this.game=b;this.gameModel=b.gameModel;this.elementTemplates={gameTree:$('\x3cdiv class\x3d"game-tree"\x3e\x3c/div\x3e'),nodeGroup:$('\x3cul class\x3d"node-group"\x3e\x3c/ul\x3e'),nodeGroupHead:$('\x3cli class\x3d"node-group-head"\x3e\x3c/li\x3e'),treeNodes:$('\x3cul class\x3d"tree-nodes"\x3e\x3c/ul\x3e'),treeNode:$('\x3cli class\x3d"tree-node"\x3e\x3cspan class\x3d"node-name"\x3e\x3c/span\x3e\x3cspan class\x3d"node-info"\x3e\x3c/span\x3e\x3c/li\x3e'),variation:$('\x3cul class\x3d"variation"\x3e\x3c/ul\x3e'),
variationHead:$('\x3cli class\x3d"variation-head"\x3e\x3c/li\x3e')};this.groupMoveCount=20}
GameTree.prototype={setup:function(){$(".game-tree",this.$container).remove();this.render()},setGroupMoveCount:function(a){"string"===typeof a&&(a=parseInt(a));if(!("number"!==typeof a||isNaN(a)||3>a)){this.groupMoveCount=a;var b=this,c=this.gameModel,d;$(".node-group",this.$container).detach().find("\x3e .tree-nodes \x3e *").each(function(){var a=$(this);a.is(".tree-node")?(b.setNodeInfo(c.nodeMap[this.id],a),b._appendRealGameNode(a),d=a):d.after(a)});$("button.show-current-node",this.$container).click()}},
render:function(){var a=this.elementTemplates;$treeNodesTmpl=a.treeNodes;$treeNodeTmpl=a.treeNode;var b=a.gameTree.clone();this.$container.append(b);var c,d,e,f=this,g={};this.gameModel.traverseNodes(function(a){var l=a.belongingVariation;if(l.realGame){var k=a.move.variationMoveNumber,m=a.previousNode,m=m&&m.move.variationMoveNumber;if(!c||1<k&&k!==m&&1==k%f.groupMoveCount)d&&f.setNodeGroupHead(d,e,m),e=k||1,k=f.createNodeGroup(e),b.append(k.$nodeGroup),c=k.$treeNodes,d=k.$nodeGroup}if(l.realGame)l=
c;else{for(;0===l.index;)l=l.parentVariation;l=g[l.id]}k=f.createNode(a);l.append(k);if(a.variations)for(k=1;k<a.variations.length;k++){var m=a.variations[k],n=f.createVariation(m),p=n.$treeNodes;l.append(n.$variation);g[m.id]=p}});d&&this.setNodeGroupHead(d,e,this.gameModel.gameEndingNode.move.variationMoveNumber)},setNodeInfo:function(a,b){var c=a.belongingVariation.realGame,d=a.move.variationMoveNumber,e;!a.status.move&&a.isSetup()?e="":(e=""+d,0===d&&(e=c?"game info":""));a.move.color&&b.addClass("B"==
a.move.color?"black":"white");c="";a.status.move||(a.status.pass?c="pass":a.isSetup()&&(c="setup"));""!=c&&(""!=e&&(e+=" "),e+=c);a.basic.N&&(e+=" "+a.basic.N);b.find(".node-name").text(e);c="";a.status.mark&&(c+=" mark");a.status.ko?c+=" ko":a.status.capture&&(c+=" capture");a.hasComment()&&(c+=" comment");" "==e.charAt(0)&&e.substr(1);b.find(".node-info").html(c);d=a.move.variationMoveNumber;b.data("mn",d)},createNode:function(a){var b=this.elementTemplates.treeNode.clone();b.attr("id",a.id);b.data("mn",
a.move.variationMoveNumber);this.setNodeInfo(a,b);return b},createVariation:function(a){var b=this.elementTemplates;$variationTmpl=b.variation;$variationHeadTmpl=b.variationHead;$treeNodesTmpl=b.treeNodes;$v=$variationTmpl.clone().attr("id",a.id);$variationHead=$variationHeadTmpl.clone();$v.append($variationHead);this.setVariationHead(a,$variationHead);a=$treeNodesTmpl.clone();$v.append(a);return{$variation:$v,$treeNodes:a}},setVariationHead:function(a,b){b||(b=$("#"+a.id,this.$container).find("\x3e .variation-head"));
var c=String.fromCharCode(65+a.index);b.html(c)},createNodeGroup:function(a){var b=this.elementTemplates;$nodeGroupTmpl=b.nodeGroup;$nodeGroupHeadTmpl=b.nodeGroupHead;$treeNodesTmpl=b.treeNodes;$nodeGroup=$nodeGroupTmpl.clone();$nodeGroup.append($nodeGroupHeadTmpl.clone());b=$treeNodesTmpl.clone();$nodeGroup.append(b);$nodeGroup.attr("id","node-group-"+a);return{$nodeGroup:$nodeGroup,$treeNodes:b}},setNodeGroupHead:function(a,b,c){b=b+"-"+(c||1);a.find("\x3e .node-group-head").text(b)},showNode:function(a,
b){$node=$("#"+a,this.$container);if(0!=$node.length&&($("li.tree-node.current",this.$container).removeClass("current"),$node.addClass("current"),$node.parents("ul.tree-nodes:hidden"),$node.parents("ul.tree-nodes").show(),b&&0<$node.length)){var c=$node.get(0);c.scrollIntoViewIfNeeded?c.scrollIntoViewIfNeeded():c.scrollIntoView()}},_appendRealGameNode:function(a){var b=a.data("mn");0===b&&(b=1);var c,d=b-(b-1)%this.groupMoveCount,e=$("#node-group-"+d,this.$container);0==e.length?(c=$(".game-tree",
this.$container),e=this.createNodeGroup(d),c.append(e.$nodeGroup),c=e.$treeNodes,e=e.$nodeGroup):c=$("\x3e .tree-nodes",e);c.append(a);this.setNodeGroupHead(e,d,b)},addNode:function(a){var b=this.createNode(a),c=a.belongingVariation;if(c.realGame)this._appendRealGameNode(b);else{for(var d=c;0===d.index;)d=d.parentVariation;var e=$("#"+d.id,this.$container);0<e.length?(d=$("\x3e .tree-nodes",e),d.append(b)):(d=this.createVariation(d),e=d.$variation,d=d.$treeNodes,d.append(b),b=$("#"+c.baseNode.id,
this.$container),c=c.baseNode.variations,2==c.length?b.after(e):$("#"+c[c.length-2].id,this.$container).after(e))}this.showNode(a.id)},removeLastNode:function(a,b){if(!a.isVariationLastNode())return!1;if(a.isVariationFirstNode()){var c=a.previousNode,d=a.belongingVariation;0==d.index?(d=$("#"+a.id,this.$container),d.remove()):$("#"+d.id,this.$container).remove();if(c.variations)for(d=0;d<c.variations.length;d++)this.setVariationHead(c.variations[d]);if(b){var e=$("#"+b.id,this.$container),d=e.find("\x3e .tree-nodes \x3e *");
e.detach();var f=this,g=this.gameModel;if(b.nodes[0].belongingVariation.realGame){var h;d.each(function(){var a=$(this);a.is(".tree-node")?(f.setNodeInfo(g.nodeMap[this.id],a),f._appendRealGameNode(a),h=a):h.after(a)})}else{for(c=c.belongingVariation;0===c.index;)c=c.parentVariation;c=$("#"+c.id+"\x3e .tree-nodes",this.$container);d.each(function(){var a=$(this);a.is(".tree-node")&&f.setNodeInfo(g.nodeMap[this.id],a)});c.append(d)}}}else if(d=$("#"+a.id,this.$container),d.remove(),a.status.move||
a.status.pass)c=a.move.variationMoveNumber,c-=(c-1)%this.groupMoveCount,d=$("#node-group-"+c,this.$container),0==d.find(" \x3e ul.tree-nodes \x3e li.tree-node").length?d.remove():(e=(e=a.previousNode)&&e.move.variationMoveNumber)&&this.setNodeGroupHead(d,c,e)},changeNodeInfo:function(a){var b=$("#"+a.id,this.$container);0!=b.length&&this.setNodeInfo(a,b)}};
GameViewer.prototype.keydownHandler=function(a){var b=this.game,c=a.ctrlKey||a.metaKey;switch(a.keyCode){case 37:c?b.previousCommentOrBranch():b.previousNode();break;case 39:c?b.nextCommentOrBranch():b.nextNode();break;case 38:a=b.curNode;b.inRealGame()?a.variations&&(a=a.variations[a.variations.length-1],a=a.nodes[0],b.gotoNode(a)):a.isVariationFirstNode()?(a=a.belongingVariation,a=a.previousVariation().nodes[0],b.gotoNode(a)):b.gotoVariationBegin();break;case 40:a=b.curNode,b.inRealGame()?a.variations&&
(a=a.variations[1],a=a.nodes[0],b.gotoNode(a)):a.isVariationLastNode()?(a=a.belongingVariation,a=a.nextVariation().nodes[0],b.gotoNode(a)):b.gotoVariationEnd()}return!0};
GameViewer.prototype.mousewheelHandler=function(a){a.preventDefault();if(this._lastWheelTS){var b=(new Date).getTime();if(100>b-this._lastWheelTS)return!1;this._lastWheelTS=b}else this._lastWheelTS=(new Date).getTime();b=this.game;!a.wheelDelta&&a.originalEvent&&(a=a.originalEvent);var c=!1;(c="number"===typeof a.wheelDelta?0<a.wheelDelta:0>a.detail)?b.previousNode():b.nextNode();return!1};function Layout(a){this.viewer=a}
yogo={_uid:1024,nextuid:function(){yogo._uid++;return yogo._uid},log:function(a,b,c){if(window.console&&((c=window.console[c])||(c=window.console.log),c instanceof Function)){b||(b="yogo");try{c.call(window.console,b+":",a)}catch(d){}}},logInfo:function(a,b){yogo.log(a,b,"info")},logWarn:function(a,b){yogo.log(a,b,"warn")},logError:function(a,b){yogo.log(a,b,"error")},exportFunctions:function(a,b){for(var c=0;c<b.length;c++){var d=b[c],e=a[d];"function"!==typeof e?yogo.logWarn(d+" is not a function"):
this[d]=e.bind(a)}},evaluatePointRange:function(a,b){for(var c=[],d=b.x,e=a.y,f=b.y,g=a.x;g<=d;g++)for(var h=e;h<=f;h++)c.push({x:g,y:h});return c},findPoint:function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(d.x===b.x&&d.y===b.y)return c}return-1},removePoint:function(a,b){if(!a)return!1;var c=yogo.findPoint(a,b);return 0<=c?(a.splice(c,1),!0):!1}};